import{k,r,d as P,j as e,H as E,f as N,B as o,L as l,s as y}from"./index-DZgJ29pE.js";import{C as w}from"./card-B25bVudG.js";import{F as G}from"./Footer-DpLvCSao.js";import{u as F}from"./useFacebookConversionsAPI-B7CoJw1t.js";import{C}from"./circle-alert-BwBH0V80.js";import{C as M}from"./circle-check-tQfM6UXB.js";import{G as _}from"./gift-CI_MJoM0.js";function O(){const[m]=k(),a=m.get("order"),d=m.get("free")==="true",[s,u]=r.useState(null),[v,n]=r.useState(!0),[x,p]=r.useState(""),[h,b]=r.useState(!1),{trackEvent:f}=P(),{trackPurchase:j}=F();return r.useEffect(()=>{if(d){u({orderId:"free",status:"paid",statusType:"success",statusMessage:"¡Compra completada! Revisa tu email para obtener tus códigos.",packageName:"Gift Card",sessionsQuantity:0,finalPrice:0}),n(!1);return}if(!a){p("No se encontró información del pedido"),n(!1);return}const i=async()=>{try{const{data:t,error:L}=await y.functions.invoke("get-order-status",{body:null,headers:{"Content-Type":"application/json"}}),g=await fetch(`https://pyupvlgdtcxgqjungiof.supabase.co/functions/v1/get-order-status?orderId=${a}`,{headers:{apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5dXB2bGdkdGN4Z3FqdW5naW9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MDU2MzYsImV4cCI6MjA3NjE4MTYzNn0.DGfGzmgZiHVDe46hMeXdhZNecFS6qKplOQHjztrNVHs"}});if(!g.ok)throw new Error("Error al obtener estado");const I=await g.json();u(I)}catch(t){console.error("Error fetching order status:",t),p("Error al verificar el estado del pago")}finally{n(!1)}};i();const c=setInterval(()=>{(s==null?void 0:s.status)==="created"&&i()},5e3);return()=>clearInterval(c)},[a,d,s==null?void 0:s.status]),r.useEffect(()=>{(async()=>{if((s==null?void 0:s.statusType)==="success"&&!h&&a){const c=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;f("Purchase",{value:s.finalPrice||0,currency:"CLP",content_name:s.packageName||"Gift Card",content_type:"product",content_ids:[a]},c);const{data:t}=await y.from("package_orders").select("buyer_email, buyer_name, buyer_phone").eq("id",a).maybeSingle();t&&j({userEmail:t.buyer_email,userName:t.buyer_name,userPhone:t.buyer_phone||void 0,value:s.finalPrice||0,currency:"CLP",contentName:s.packageName||"Gift Card",orderId:a,eventId:c}),b(!0)}})()},[s==null?void 0:s.statusType,s==null?void 0:s.finalPrice,s==null?void 0:s.packageName,a,h,f,j]),e.jsxs(e.Fragment,{children:[e.jsx(E,{children:e.jsx("title",{children:"Compra Exitosa - Gift Cards - Studio La Nave"})}),e.jsx("main",{className:"min-h-screen pt-24 pb-16 px-4 flex items-center justify-center",children:e.jsx(w,{className:"max-w-md w-full p-8 text-center",children:v?e.jsxs("div",{className:"space-y-4",children:[e.jsx(N,{className:"h-12 w-12 animate-spin mx-auto text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Verificando pago..."})]}):x?e.jsxs("div",{className:"space-y-4",children:[e.jsx(C,{className:"h-12 w-12 mx-auto text-destructive"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Error"}),e.jsx("p",{className:"text-muted-foreground",children:x}),e.jsx(o,{asChild:!0,children:e.jsx(l,{to:"/giftcards",children:"Volver a Gift Cards"})})]}):(s==null?void 0:s.statusType)==="success"?e.jsxs("div",{className:"space-y-4",children:[e.jsx(M,{className:"h-16 w-16 mx-auto text-green-600"}),e.jsx("h1",{className:"text-2xl font-bold text-green-600",children:"¡Compra Exitosa!"}),e.jsx("p",{className:"text-muted-foreground",children:s.statusMessage}),s.packageName&&e.jsxs("div",{className:"bg-primary/10 rounded-lg p-4 mt-4",children:[e.jsx(_,{className:"h-6 w-6 mx-auto text-primary mb-2"}),e.jsx("p",{className:"font-semibold",children:s.packageName})]}),e.jsx(o,{asChild:!0,className:"mt-6",children:e.jsx(l,{to:"/",children:"Volver al inicio"})})]}):(s==null?void 0:s.statusType)==="pending"?e.jsxs("div",{className:"space-y-4",children:[e.jsx(N,{className:"h-12 w-12 animate-spin mx-auto text-primary"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Procesando Pago"}),e.jsx("p",{className:"text-muted-foreground",children:s.statusMessage}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Esta página se actualizará automáticamente..."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(C,{className:"h-12 w-12 mx-auto text-destructive"}),e.jsx("h1",{className:"text-2xl font-bold text-destructive",children:"Pago No Completado"}),e.jsx("p",{className:"text-muted-foreground",children:s==null?void 0:s.statusMessage}),e.jsx(o,{asChild:!0,children:e.jsx(l,{to:"/giftcards",children:"Intentar nuevamente"})})]})})}),e.jsx(G,{})]})}export{O as default};
