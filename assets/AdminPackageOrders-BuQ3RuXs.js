import{r as l,s as A,j as e,B as G,I as U,f as $}from"./index-IYv-o_LZ.js";import{B as d}from"./badge-D7z4mQ5S.js";import{C as f,a as b,b as y,c as j}from"./card-BzXwkPKq.js";import{S as C,a as w,b as T,c as P,d as c}from"./select-CqgsOY3A.js";import{T as z,a as J,b as S,c as r,d as K,e as n}from"./table-l1OCyKq7.js";import{D as Q}from"./download-TImcyGlN.js";import{S as W}from"./search-dXZmVU6J.js";import{k as p,n as X}from"./es-BGq_Vek6.js";import"./index-xHwMhLcE.js";import"./index-D0po66-R.js";import"./chevron-down-CaUqBoSJ.js";import"./chevron-up-CDSinjhX.js";import"./check-flsLmVj_.js";function me(){const[N,E]=l.useState([]),[i,D]=l.useState([]),[x,F]=l.useState(""),[u,I]=l.useState("all"),[h,k]=l.useState("all"),[L,_]=l.useState(!0);l.useEffect(()=>{M()},[]),l.useEffect(()=>{B()},[N,x,u,h]);const M=async()=>{_(!0);const{data:s,error:a}=await A.from("package_orders").select("*, session_packages(name)").order("created_at",{ascending:!1});a?console.error("Error loading orders:",a):E(s||[]),_(!1)},B=()=>{let s=[...N];if(x){const a=x.toLowerCase();s=s.filter(o=>o.buyer_name.toLowerCase().includes(a)||o.buyer_email.toLowerCase().includes(a)||o.id.toLowerCase().includes(a))}u!=="all"&&(s=s.filter(a=>a.status===u)),h!=="all"&&(h==="giftcard"?s=s.filter(a=>a.is_giftcard):s=s.filter(a=>!a.is_giftcard)),D(s)},H=s=>{switch(s){case"paid":return e.jsx(d,{className:"bg-green-500 hover:bg-green-600",children:"Pagada"});case"created":return e.jsx(d,{className:"bg-yellow-500 hover:bg-yellow-600",children:"Pendiente"});case"failed":return e.jsx(d,{className:"bg-red-500 hover:bg-red-600",children:"Fallida"});default:return e.jsx(d,{variant:"secondary",children:s})}},g=s=>new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP"}).format(s),O=()=>{const s=["ID","Fecha","Nombre","Email","Teléfono","Paquete","Tipo","Estado","Precio Original","Descuento","Precio Final","Cupón","ID Pago MP","Estado MP"],a=i.map(t=>{var v;return[t.id,p(new Date(t.created_at),"dd/MM/yyyy HH:mm"),t.buyer_name,t.buyer_email,t.buyer_phone||"",((v=t.session_packages)==null?void 0:v.name)||"",t.is_giftcard?"Gift Card":"Paquete",t.status,t.original_price,t.discount_amount,t.final_price,t.coupon_code||"",t.mercado_pago_payment_id||"",t.mercado_pago_status||""]}),o="data:text/csv;charset=utf-8,"+[s,...a].map(t=>t.join(",")).join(`
`),R=encodeURI(o),m=document.createElement("a");m.setAttribute("href",R),m.setAttribute("download",`ordenes_${p(new Date,"yyyy-MM-dd")}.csv`),document.body.appendChild(m),m.click(),document.body.removeChild(m)},q=i.filter(s=>s.status==="paid").reduce((s,a)=>s+a.final_price,0),V=i.filter(s=>s.status==="paid").length;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Órdenes de Compra"}),e.jsxs(G,{onClick:O,variant:"outline",className:"gap-2",children:[e.jsx(Q,{className:"h-4 w-4"}),"Exportar CSV"]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(f,{children:[e.jsx(b,{className:"pb-2",children:e.jsx(y,{className:"text-sm font-medium text-muted-foreground",children:"Total Órdenes"})}),e.jsx(j,{children:e.jsx("div",{className:"text-2xl font-bold",children:i.length})})]}),e.jsxs(f,{children:[e.jsx(b,{className:"pb-2",children:e.jsx(y,{className:"text-sm font-medium text-muted-foreground",children:"Órdenes Pagadas"})}),e.jsx(j,{children:e.jsx("div",{className:"text-2xl font-bold text-green-600",children:V})})]}),e.jsxs(f,{children:[e.jsx(b,{className:"pb-2",children:e.jsx(y,{className:"text-sm font-medium text-muted-foreground",children:"Ingresos Totales"})}),e.jsx(j,{children:e.jsx("div",{className:"text-2xl font-bold text-green-600",children:g(q)})})]})]}),e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(W,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(U,{placeholder:"Buscar por nombre, email o ID...",value:x,onChange:s=>F(s.target.value),className:"pl-10"})]}),e.jsxs(C,{value:u,onValueChange:I,children:[e.jsx(w,{className:"w-full md:w-[180px]",children:e.jsx(T,{placeholder:"Estado"})}),e.jsxs(P,{children:[e.jsx(c,{value:"all",children:"Todos los estados"}),e.jsx(c,{value:"paid",children:"Pagadas"}),e.jsx(c,{value:"created",children:"Pendientes"}),e.jsx(c,{value:"failed",children:"Fallidas"})]})]}),e.jsxs(C,{value:h,onValueChange:k,children:[e.jsx(w,{className:"w-full md:w-[180px]",children:e.jsx(T,{placeholder:"Tipo"})}),e.jsxs(P,{children:[e.jsx(c,{value:"all",children:"Todos los tipos"}),e.jsx(c,{value:"giftcard",children:"Gift Cards"}),e.jsx(c,{value:"package",children:"Paquetes"})]})]})]}),L?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx($,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):i.length===0?e.jsx(f,{children:e.jsx(j,{className:"py-12 text-center text-muted-foreground",children:"No se encontraron órdenes"})}):e.jsx("div",{className:"rounded-md border",children:e.jsxs(z,{children:[e.jsx(J,{children:e.jsxs(S,{children:[e.jsx(r,{children:"Fecha"}),e.jsx(r,{children:"Comprador"}),e.jsx(r,{children:"Paquete"}),e.jsx(r,{children:"Tipo"}),e.jsx(r,{children:"Estado"}),e.jsx(r,{className:"text-right",children:"Precio"}),e.jsx(r,{children:"Cupón"}),e.jsx(r,{children:"ID Pago"})]})}),e.jsx(K,{children:i.map(s=>{var a;return e.jsxs(S,{children:[e.jsxs(n,{className:"whitespace-nowrap",children:[p(new Date(s.created_at),"dd MMM yyyy",{locale:X}),e.jsx("br",{}),e.jsx("span",{className:"text-xs text-muted-foreground",children:p(new Date(s.created_at),"HH:mm")})]}),e.jsxs(n,{children:[e.jsx("div",{className:"font-medium",children:s.buyer_name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.buyer_email}),s.buyer_phone&&e.jsx("div",{className:"text-xs text-muted-foreground",children:s.buyer_phone})]}),e.jsx(n,{children:((a=s.session_packages)==null?void 0:a.name)||"—"}),e.jsx(n,{children:e.jsx(d,{variant:s.is_giftcard?"default":"secondary",children:s.is_giftcard?"Gift Card":"Paquete"})}),e.jsx(n,{children:H(s.status)}),e.jsxs(n,{className:"text-right",children:[e.jsx("div",{className:"font-medium",children:g(s.final_price)}),s.discount_amount>0&&e.jsx("div",{className:"text-xs text-muted-foreground line-through",children:g(s.original_price)})]}),e.jsx(n,{children:s.coupon_code?e.jsx(d,{variant:"outline",children:s.coupon_code}):"—"}),e.jsx(n,{className:"max-w-[100px] truncate text-xs text-muted-foreground",children:s.mercado_pago_payment_id||"—"})]},s.id)})})]})})]})}export{me as default};
