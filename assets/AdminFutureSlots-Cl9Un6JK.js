import{c as ae,V as re,r as o,j as e,B as u,f as I,I as S,Y as te,Z as ie,_ as ne,$ as oe,aC as le,g as j,s as p}from"./index-DgMpF62C.js";import{u as b}from"./useQuery-BTxbnbv1.js";import{u as $}from"./useMutation-CWL1BRlX.js";import{L as f}from"./label-CE2J_Qba.js";import{T as ce,a as de,b as A,c as i,d as me,e as n}from"./table-BxbxVbda.js";import{S as G,a as P,b as R,c as z,d as g}from"./select-8dj-i9Ck.js";import{C as L,a as K,b as Q,d as xe,c as V}from"./card-C8hB7ibz.js";import{R as he}from"./refresh-cw-Dhjq5RDc.js";import{C as ue}from"./calendar-W0oJVRV6.js";import{k as l,n as v}from"./es-BGq_Vek6.js";import{a as je}from"./addDays-B8LDbFV8.js";import{p as M}from"./parseISO-B7l4lJ9E.js";import"./index-B-Iwk0i_.js";import"./index-DJwoYwHJ.js";import"./chevron-down-DGyKDyC-.js";import"./chevron-up-BWEP_Trh.js";import"./check-ChRAgIYV.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=ae("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);function He(){var q,k;const w=re(),[c,B]=o.useState("all"),[d,O]=o.useState("all"),[x,Y]=o.useState(l(new Date,"yyyy-MM-dd")),[h,Z]=o.useState(l(je(new Date,30),"yyyy-MM-dd")),[t,y]=o.useState(null),[N,T]=o.useState(1),[E,F]=o.useState(!1),{data:_}=b({queryKey:["professionals"],queryFn:async()=>{const{data:s,error:a}=await p.from("professionals").select("*").eq("is_active",!0).order("name");if(a)throw a;return s}}),{data:C}=b({queryKey:["services"],queryFn:async()=>{const{data:s,error:a}=await p.from("services").select("*").eq("is_active",!0).order("name");if(a)throw a;return s}}),{data:m,isLoading:J}=b({queryKey:["generated-slots",c,d,x,h],queryFn:async()=>{let s=p.from("generated_slots").select(`
          *,
          professionals:professional_id(name),
          services:service_id(name)
        `).gte("date_time_start",`${x}T00:00:00`).lte("date_time_start",`${h}T23:59:59`).order("date_time_start",{ascending:!0});c!=="all"&&(s=s.eq("professional_id",c)),d!=="all"&&(s=s.eq("service_id",d));const{data:a,error:r}=await s;if(r)throw r;return a}}),D=$({mutationFn:async({id:s,updates:a})=>{const{error:r}=await p.from("generated_slots").update(a).eq("id",s);if(r)throw r},onSuccess:()=>{w.invalidateQueries({queryKey:["generated-slots"]}),j.success("Slot actualizado exitosamente"),y(null)},onError:s=>{j.error(`Error al actualizar slot: ${s.message}`)}}),U=$({mutationFn:async s=>{const{data:a,error:r}=await p.functions.invoke("generate-future-slots",{body:{dateFrom:s.dateFrom,dateTo:s.dateTo,professionalId:c!=="all"?c:void 0,serviceId:d!=="all"?d:void 0}});if(r)throw r;return a},onSuccess:s=>{w.invalidateQueries({queryKey:["generated-slots"]}),j.success(`${s.slotsCreated} slots generados exitosamente`)},onError:s=>{j.error(`Error al generar slots: ${s.message}`)}}),W=async()=>{const s=new Date(x),a=new Date(h);if(a<s){j.error("La fecha 'hasta' debe ser posterior a la fecha 'desde'");return}if(window.confirm(`Se generarán slots para el período:
${l(s,"d MMM yyyy",{locale:v})} - ${l(a,"d MMM yyyy",{locale:v})}

¿Confirmar?`)){F(!0);try{await U.mutateAsync({dateFrom:x,dateTo:h})}finally{F(!1)}}},X=s=>{y(s),T(s.max_capacity)},ee=()=>{t&&D.mutate({id:t.id,updates:{max_capacity:N}})},se=s=>{D.mutate({id:s.id,updates:{is_active:!s.is_active}})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Agendas Futuras"}),e.jsx("p",{className:"text-muted-foreground",children:"Gestiona los cupos de todas las agendas a futuro"})]}),e.jsx(u,{onClick:W,disabled:E,size:"lg",children:E?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"mr-2 h-4 w-4 animate-spin"}),"Generando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"mr-2 h-4 w-4"}),"Generar Slots para Rango Actual"]})})]}),e.jsxs(L,{children:[e.jsxs(K,{children:[e.jsx(Q,{children:"Filtros"}),e.jsx(xe,{children:"Filtra las agendas por profesional, servicio y fecha"})]}),e.jsx(V,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(f,{children:"Profesional"}),e.jsxs(G,{value:c,onValueChange:B,children:[e.jsx(P,{children:e.jsx(R,{placeholder:"Todos"})}),e.jsxs(z,{children:[e.jsx(g,{value:"all",children:"Todos"}),_==null?void 0:_.map(s=>e.jsx(g,{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Servicio"}),e.jsxs(G,{value:d,onValueChange:O,children:[e.jsx(P,{children:e.jsx(R,{placeholder:"Todos"})}),e.jsxs(z,{children:[e.jsx(g,{value:"all",children:"Todos"}),C==null?void 0:C.map(s=>e.jsx(g,{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Fecha Desde"}),e.jsx(S,{type:"date",value:x,onChange:s=>Y(s.target.value)})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Fecha Hasta"}),e.jsx(S,{type:"date",value:h,onChange:s=>Z(s.target.value)})]})]})})]}),e.jsxs(L,{children:[e.jsx(K,{children:e.jsxs(Q,{children:["Slots Generados (",(m==null?void 0:m.length)||0,")"]})}),e.jsx(V,{children:J?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(I,{className:"h-8 w-8 animate-spin"})}):!m||m.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ue,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No se encontraron slots con estos filtros"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(A,{children:[e.jsx(i,{children:"Fecha"}),e.jsx(i,{children:"Hora"}),e.jsx(i,{children:"Profesional"}),e.jsx(i,{children:"Servicio"}),e.jsx(i,{children:"Cupos Máx"}),e.jsx(i,{children:"Reservados"}),e.jsx(i,{children:"Disponibles"}),e.jsx(i,{children:"Estado"}),e.jsx(i,{children:"Acciones"})]})}),e.jsx(me,{children:m.map(s=>{var r,H;const a=s.max_capacity-s.confirmed_bookings;return e.jsxs(A,{className:s.is_active?"":"opacity-50",children:[e.jsx(n,{children:l(M(s.date_time_start),"EEEE d MMM yyyy",{locale:v})}),e.jsx(n,{children:l(M(s.date_time_start),"HH:mm")}),e.jsx(n,{children:(r=s.professionals)==null?void 0:r.name}),e.jsx(n,{children:(H=s.services)==null?void 0:H.name}),e.jsx(n,{children:s.max_capacity}),e.jsx(n,{children:s.confirmed_bookings}),e.jsx(n,{children:e.jsx("span",{className:a<=0?"text-destructive font-bold":"",children:a})}),e.jsx(n,{children:e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${s.is_active?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s.is_active?"Activo":"Inactivo"})}),e.jsx(n,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",size:"sm",onClick:()=>X(s),children:e.jsx(pe,{className:"h-4 w-4"})}),e.jsx(u,{variant:s.is_active?"destructive":"default",size:"sm",onClick:()=>se(s),children:s.is_active?"Desactivar":"Activar"})]})})]},s.id)})})]})})})]}),e.jsx(te,{open:!!t,onOpenChange:()=>y(null),children:e.jsxs(ie,{children:[e.jsx(ne,{children:e.jsx(oe,{children:"Editar Cupos"})}),t&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:l(M(t.date_time_start),"EEEE d MMMM yyyy 'a las' HH:mm",{locale:v})}),e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"Profesional:"})," ",(q=t.professionals)==null?void 0:q.name]}),e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"Servicio:"})," ",(k=t.services)==null?void 0:k.name]}),e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"Reservas Confirmadas:"})," ",t.confirmed_bookings]})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"max_capacity",children:"Cupos Máximos"}),e.jsx(S,{id:"max_capacity",type:"number",min:t.confirmed_bookings,value:N,onChange:s=>T(parseInt(s.target.value))}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Mínimo: ",t.confirmed_bookings," (reservas confirmadas)"]})]})]}),e.jsxs(le,{children:[e.jsx(u,{variant:"outline",onClick:()=>y(null),children:"Cancelar"}),e.jsx(u,{onClick:ee,children:"Guardar"})]})]})})]})}export{He as default};
