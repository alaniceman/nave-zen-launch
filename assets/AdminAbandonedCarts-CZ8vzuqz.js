import{r as p,s as Z,g as S,j as e,B as A,l as R,I as U,f as q}from"./index-D2jBbZS7.js";import{B as z}from"./badge-CKfv1vdZ.js";import{C as D,a as I,b as E,c as C}from"./card-OYLB4Vmq.js";import{T as $,a as Q,b as B,c as y,d as W,e as N}from"./table-DKjfbaBy.js";import{S as K}from"./shopping-cart-BDxoZa8Z.js";import{D as ee}from"./download-BAXTxX3F.js";import{S as ae}from"./search-DeJMuAO-.js";import{t as d,c as te,e as se,g as F,q as G,r as T,b as ne,k as O,n as P}from"./es-BGq_Vek6.js";import{d as re}from"./differenceInCalendarMonths-CpYfiirj.js";import{e as ie}from"./endOfMonth-BdjgvUvn.js";import{C as ce}from"./circle-check-DhYKP0aR.js";function k(n,r){const t=d(n),o=d(r),s=t.getTime()-o.getTime();return s<0?-1:s>0?1:s}function le(n){return te(n,Date.now())}function oe(n){return r=>{const o=(n?Math[n]:Math.trunc)(r);return o===0?0:o}}function de(n,r){return+d(n)-+d(r)}function me(n){const r=d(n);return r.setHours(23,59,59,999),r}function ue(n){const r=d(n);return+me(r)==+ie(r)}function fe(n,r){const t=d(n),o=d(r),s=k(t,o),x=Math.abs(re(t,o));let h;if(x<1)h=0;else{t.getMonth()===1&&t.getDate()>27&&t.setDate(30),t.setMonth(t.getMonth()-s*x);let i=k(t,o)===-s;ue(d(n))&&x===1&&k(n,o)===1&&(i=!1),h=s*(x-Number(i))}return h===0?0:h}function he(n,r,t){const o=de(n,r)/1e3;return oe(t==null?void 0:t.roundingMethod)(o)}function xe(n,r,t){const o=ne(),s=(t==null?void 0:t.locale)??o.locale??se,x=2520,h=k(n,r);if(isNaN(h))throw new RangeError("Invalid time value");const i=Object.assign({},t,{addSuffix:t==null?void 0:t.addSuffix,comparison:h});let g,j;h>0?(g=d(r),j=d(n)):(g=d(n),j=d(r));const b=he(j,g),H=(F(j)-F(g))/1e3,l=Math.round((b-H)/60);let _;if(l<2)return t!=null&&t.includeSeconds?b<5?s.formatDistance("lessThanXSeconds",5,i):b<10?s.formatDistance("lessThanXSeconds",10,i):b<20?s.formatDistance("lessThanXSeconds",20,i):b<40?s.formatDistance("halfAMinute",0,i):b<60?s.formatDistance("lessThanXMinutes",1,i):s.formatDistance("xMinutes",1,i):l===0?s.formatDistance("lessThanXMinutes",1,i):s.formatDistance("xMinutes",l,i);if(l<45)return s.formatDistance("xMinutes",l,i);if(l<90)return s.formatDistance("aboutXHours",1,i);if(l<G){const f=Math.round(l/60);return s.formatDistance("aboutXHours",f,i)}else{if(l<x)return s.formatDistance("xDays",1,i);if(l<T){const f=Math.round(l/G);return s.formatDistance("xDays",f,i)}else if(l<T*2)return _=Math.round(l/T),s.formatDistance("aboutXMonths",_,i)}if(_=fe(j,g),_<12){const f=Math.round(l/T);return s.formatDistance("xMonths",f,i)}else{const f=_%12,M=Math.trunc(_/12);return f<3?s.formatDistance("aboutXYears",M,i):f<9?s.formatDistance("overXYears",M,i):s.formatDistance("almostXYears",M+1,i)}}function J(n,r){return xe(n,le(n),r)}function Ce(){const[n,r]=p.useState([]),[t,o]=p.useState([]),[s,x]=p.useState(""),[h,i]=p.useState(!0),[g,j]=p.useState(null);p.useEffect(()=>{b()},[]),p.useEffect(()=>{H()},[n,s]);const b=async()=>{i(!0);const a=new Date(Date.now()-30*60*1e3).toISOString(),{data:c,error:m}=await Z.from("package_orders").select("id, created_at, buyer_name, buyer_email, buyer_phone, package_id, order_type, is_giftcard, original_price, final_price, abandonment_email_sent_at, session_packages(name)").eq("status","created").lt("created_at",a).order("created_at",{ascending:!1});m?(console.error("Error loading abandoned orders:",m),S.error("Error al cargar carros abandonados")):r(c||[]),i(!1)},H=()=>{let a=[...n];if(s){const c=s.toLowerCase();a=a.filter(m=>m.buyer_name.toLowerCase().includes(c)||m.buyer_email.toLowerCase().includes(c))}o(a)},l=async a=>{var c;j(a.id);try{if(!(await fetch("https://pyupvlgdtcxgqjungiof.supabase.co/functions/v1/send-abandonment-email",{method:"POST",headers:{"Content-Type":"application/json",apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5dXB2bGdkdGN4Z3FqdW5naW9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MDU2MzYsImV4cCI6MjA3NjE4MTYzNn0.DGfGzmgZiHVDe46hMeXdhZNecFS6qKplOQHjztrNVHs"},body:JSON.stringify({orderId:a.id,buyerEmail:a.buyer_email,buyerName:a.buyer_name,packageName:((c=a.session_packages)==null?void 0:c.name)||"Paquete de sesiones",finalPrice:a.final_price,isGiftCard:a.is_giftcard})})).ok)throw new Error("Error al enviar email");S.success(`Email de recuperaciÃ³n enviado a ${a.buyer_email}`),r(n.map(v=>v.id===a.id?{...v,abandonment_email_sent_at:new Date().toISOString()}:v))}catch(m){console.error("Error sending recovery email:",m),S.error("Error al enviar email de recuperaciÃ³n")}finally{j(null)}},_=async()=>{const a=t.filter(c=>!c.abandonment_email_sent_at);if(a.length===0){S.info("No hay emails pendientes de enviar");return}for(const c of a)await l(c),await new Promise(m=>setTimeout(m,500))},f=a=>new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP"}).format(a),M=()=>{const a=["ID","Fecha","Hace cuÃ¡nto","Nombre","Email","TelÃ©fono","Paquete","Tipo","Precio","Email Enviado"],c=t.map(u=>{var L;return[u.id,O(new Date(u.created_at),"dd/MM/yyyy HH:mm"),J(new Date(u.created_at),{addSuffix:!0,locale:P}),u.buyer_name,u.buyer_email,u.buyer_phone||"",((L=u.session_packages)==null?void 0:L.name)||"",u.is_giftcard?"Gift Card":"Paquete",u.final_price,u.abandonment_email_sent_at?"SÃ­":"No"]}),m="data:text/csv;charset=utf-8,"+[a,...c].map(u=>u.join(",")).join(`
`),v=encodeURI(m),w=document.createElement("a");w.setAttribute("href",v),w.setAttribute("download",`carros_abandonados_${O(new Date,"yyyy-MM-dd")}.csv`),document.body.appendChild(w),w.click(),document.body.removeChild(w)},Y=t.reduce((a,c)=>a+c.final_price,0),X=t.filter(a=>!a.abandonment_email_sent_at).length,V=t.filter(a=>a.abandonment_email_sent_at).length;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(K,{className:"h-6 w-6"}),"Carros Abandonados"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(A,{onClick:_,variant:"default",className:"gap-2",disabled:X===0,children:[e.jsx(R,{className:"h-4 w-4"}),"Enviar todos (",X,")"]}),e.jsxs(A,{onClick:M,variant:"outline",className:"gap-2",children:[e.jsx(ee,{className:"h-4 w-4"}),"Exportar CSV"]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(D,{children:[e.jsx(I,{className:"pb-2",children:e.jsx(E,{className:"text-sm font-medium text-muted-foreground",children:"Carros Abandonados"})}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold",children:t.length})})]}),e.jsxs(D,{children:[e.jsx(I,{className:"pb-2",children:e.jsx(E,{className:"text-sm font-medium text-muted-foreground",children:"Ingresos Perdidos"})}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold text-red-600",children:f(Y)})})]}),e.jsxs(D,{children:[e.jsx(I,{className:"pb-2",children:e.jsx(E,{className:"text-sm font-medium text-muted-foreground",children:"Emails Pendientes"})}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:X})})]}),e.jsxs(D,{children:[e.jsx(I,{className:"pb-2",children:e.jsx(E,{className:"text-sm font-medium text-muted-foreground",children:"Emails Enviados"})}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold text-green-600",children:V})})]})]}),e.jsxs("div",{className:"relative max-w-md",children:[e.jsx(ae,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(U,{placeholder:"Buscar por nombre o email...",value:s,onChange:a=>x(a.target.value),className:"pl-10"})]}),h?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(q,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):t.length===0?e.jsx(D,{children:e.jsx(C,{className:"py-12 text-center text-muted-foreground",children:"ðŸŽ‰ No hay carros abandonados"})}):e.jsx("div",{className:"rounded-md border",children:e.jsxs($,{children:[e.jsx(Q,{children:e.jsxs(B,{children:[e.jsx(y,{children:"Hace cuÃ¡nto"}),e.jsx(y,{children:"Comprador"}),e.jsx(y,{children:"Paquete"}),e.jsx(y,{children:"Tipo"}),e.jsx(y,{className:"text-right",children:"Precio"}),e.jsx(y,{children:"Email Enviado"}),e.jsx(y,{className:"text-right",children:"Acciones"})]})}),e.jsx(W,{children:t.map(a=>{var c;return e.jsxs(B,{children:[e.jsxs(N,{children:[e.jsx("div",{className:"font-medium",children:J(new Date(a.created_at),{addSuffix:!0,locale:P})}),e.jsx("div",{className:"text-xs text-muted-foreground",children:O(new Date(a.created_at),"dd MMM HH:mm",{locale:P})})]}),e.jsxs(N,{children:[e.jsx("div",{className:"font-medium",children:a.buyer_name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:a.buyer_email}),a.buyer_phone&&e.jsx("div",{className:"text-xs text-muted-foreground",children:a.buyer_phone})]}),e.jsx(N,{children:((c=a.session_packages)==null?void 0:c.name)||"â€”"}),e.jsx(N,{children:e.jsx(z,{variant:a.is_giftcard?"default":"secondary",children:a.is_giftcard?"Gift Card":"Paquete"})}),e.jsx(N,{className:"text-right font-medium",children:f(a.final_price)}),e.jsx(N,{children:a.abandonment_email_sent_at?e.jsxs("div",{className:"flex items-center gap-1 text-green-600",children:[e.jsx(ce,{className:"h-4 w-4"}),e.jsx("span",{className:"text-xs",children:O(new Date(a.abandonment_email_sent_at),"dd/MM HH:mm")})]}):e.jsx(z,{variant:"outline",className:"text-yellow-600 border-yellow-600",children:"Pendiente"})}),e.jsx(N,{className:"text-right",children:e.jsxs(A,{size:"sm",variant:a.abandonment_email_sent_at?"outline":"default",onClick:()=>l(a),disabled:g===a.id,className:"gap-1",children:[g===a.id?e.jsx(q,{className:"h-3 w-3 animate-spin"}):e.jsx(R,{className:"h-3 w-3"}),a.abandonment_email_sent_at?"Reenviar":"Enviar"]})})]},a.id)})})]})})]})}export{Ce as default};
