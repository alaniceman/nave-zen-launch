import{c as Q,V as K,r as F,j as e,Y as R,Z as G,_ as Z,$ as Y,I as b,B as T,f as U,s as f,g as S}from"./index-D2jBbZS7.js";import{u as O}from"./useQuery-B-fiS_pv.js";import{u as V}from"./useMutation-DhgzXs9Y.js";import{C as J,c as W}from"./card-OYLB4Vmq.js";import{T as X,a as ee,b as M,c as u,d as se,e as d}from"./table-DKjfbaBy.js";import{u as ae}from"./index.esm-DtCC8THk.js";import{o as ne,s as A,e as re,n as L,a as ie,t as te}from"./zod-BDXfkOj5.js";import{F as le,a as j,b as g,c as m,d as _,f as N,e as v}from"./form-BJG7YqIO.js";import{C as oe,S as ce}from"./switch-DB6L8MX_.js";import{S as de,a as ue,b as me,c as xe,d as z}from"./select-DhA8D-pX.js";import{B as E}from"./badge-CKfv1vdZ.js";import{A as he,b as pe,c as je,d as ge,e as _e,f as ve,g as fe,h as ye}from"./alert-dialog-DuN13zaQ.js";import{P as Ce}from"./plus-B9yfqEjj.js";import{D as be}from"./dollar-sign-DoVVBuHW.js";import{P as Ne}from"./pencil-CmCykS61.js";import{T as Se}from"./trash-2-DtONYPdm.js";import{k as B,n as $}from"./es-BGq_Vek6.js";import"./label-MfefNPtF.js";import"./index-q10XEKNx.js";import"./check-DlvlGAKd.js";import"./index-DuNgS-Bs.js";import"./chevron-down-FFjHraMF.js";import"./chevron-up-FXiSCfMY.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=Q("Percent",[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]]),De=ne({code:A().min(3,"El código debe tener al menos 3 caracteres").max(20,"El código no puede exceder 20 caracteres").regex(/^[A-Z0-9]+$/,"El código solo puede contener letras mayúsculas y números").transform(l=>l.toUpperCase()),discount_type:re(["percentage","fixed_amount"],{required_error:"Selecciona un tipo de descuento"}),discount_value:L().min(1,"El valor debe ser mayor a 0").positive("El valor debe ser positivo"),min_purchase_amount:L().min(0,"El monto mínimo no puede ser negativo").default(0),max_uses:L().nullable().refine(l=>l===null||l>0,"Los usos máximos deben ser mayor a 0").optional(),valid_from:A().optional(),valid_until:A().nullable().optional(),applicable_package_ids:ie(A()).optional()}).refine(l=>l.discount_type==="percentage"?l.discount_value<=100:!0,{message:"El porcentaje no puede ser mayor a 100",path:["discount_value"]});function Ee({open:l,onClose:w,coupon:r}){const q=K(),x=!!r,[h,p]=F.useState([]),{data:c=[]}=O({queryKey:["session-packages-for-coupons"],queryFn:async()=>{const{data:s,error:n}=await f.from("session_packages").select("*").eq("is_active",!0).order("sessions_quantity",{ascending:!0});if(n)throw n;return s||[]}}),i=ae({resolver:te(De),defaultValues:{code:"",discount_type:"percentage",discount_value:10,min_purchase_amount:0,max_uses:null,valid_from:new Date().toISOString().split("T")[0],valid_until:null,applicable_package_ids:[]}});F.useEffect(()=>{r?(i.reset({code:r.code,discount_type:r.discount_type,discount_value:r.discount_value,min_purchase_amount:r.min_purchase_amount||0,max_uses:r.max_uses,valid_from:r.valid_from?new Date(r.valid_from).toISOString().split("T")[0]:void 0,valid_until:r.valid_until?new Date(r.valid_until).toISOString().split("T")[0]:null,applicable_package_ids:r.applicable_package_ids||[]}),p(r.applicable_package_ids||[])):(i.reset({code:"",discount_type:"percentage",discount_value:10,min_purchase_amount:0,max_uses:null,valid_from:new Date().toISOString().split("T")[0],valid_until:null,applicable_package_ids:[]}),p([]))},[r,i,l]);const y=V({mutationFn:async s=>{const n={code:s.code,discount_type:s.discount_type,discount_value:s.discount_value,min_purchase_amount:s.min_purchase_amount,max_uses:s.max_uses||null,valid_from:s.valid_from||new Date().toISOString(),valid_until:s.valid_until||null,applicable_package_ids:h.length>0?h:null};if(x){const{error:o}=await f.from("discount_coupons").update(n).eq("id",r.id);if(o)throw o}else{const{error:o}=await f.from("discount_coupons").insert([n]);if(o)throw o}},onSuccess:()=>{q.invalidateQueries({queryKey:["coupons-admin"]}),S.success(x?"Cupón actualizado":"Cupón creado"),w(),i.reset()},onError:s=>{S.error(s.message||"Error al guardar cupón")}}),P=s=>{y.mutate(s)},k=i.watch("discount_type");return e.jsx(R,{open:l,onOpenChange:w,children:e.jsxs(G,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Z,{children:e.jsx(Y,{children:x?"Editar Cupón":"Crear Nuevo Cupón"})}),e.jsx(le,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit(P),className:"space-y-4",children:[e.jsx(j,{control:i.control,name:"code",render:({field:s})=>e.jsxs(g,{children:[e.jsx(m,{children:"Código del cupón *"}),e.jsx(_,{children:e.jsx(b,{...s,placeholder:"DESCUENTO20",className:"font-mono uppercase",onChange:n=>s.onChange(n.target.value.toUpperCase())})}),e.jsx(N,{children:"Solo letras mayúsculas y números (ej: VERANO2025)"}),e.jsx(v,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(j,{control:i.control,name:"discount_type",render:({field:s})=>e.jsxs(g,{children:[e.jsx(m,{children:"Tipo de descuento *"}),e.jsxs(de,{onValueChange:s.onChange,value:s.value,children:[e.jsx(_,{children:e.jsx(ue,{children:e.jsx(me,{placeholder:"Selecciona tipo"})})}),e.jsxs(xe,{children:[e.jsx(z,{value:"percentage",children:"Porcentaje (%)"}),e.jsx(z,{value:"fixed_amount",children:"Monto fijo ($)"})]})]}),e.jsx(v,{})]})}),e.jsx(j,{control:i.control,name:"discount_value",render:({field:s})=>e.jsxs(g,{children:[e.jsx(m,{children:"Valor del descuento *"}),e.jsx(_,{children:e.jsx(b,{type:"number",...s,onChange:n=>s.onChange(parseFloat(n.target.value)),placeholder:k==="percentage"?"20":"5000"})}),e.jsx(N,{children:k==="percentage"?"Porcentaje (1-100)":"Monto en CLP"}),e.jsx(v,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(j,{control:i.control,name:"min_purchase_amount",render:({field:s})=>e.jsxs(g,{children:[e.jsx(m,{children:"Compra mínima (CLP)"}),e.jsx(_,{children:e.jsx(b,{type:"number",...s,onChange:n=>s.onChange(parseFloat(n.target.value)||0),placeholder:"0"})}),e.jsx(N,{children:"Monto mínimo para usar el cupón (0 = sin mínimo)"}),e.jsx(v,{})]})}),e.jsx(j,{control:i.control,name:"max_uses",render:({field:s})=>e.jsxs(g,{children:[e.jsx(m,{children:"Usos máximos"}),e.jsx(_,{children:e.jsx(b,{type:"number",...s,value:s.value??"",onChange:n=>s.onChange(n.target.value?parseInt(n.target.value):null),placeholder:"Ilimitado"})}),e.jsx(N,{children:"Dejar vacío para ilimitado"}),e.jsx(v,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(j,{control:i.control,name:"valid_from",render:({field:s})=>e.jsxs(g,{children:[e.jsx(m,{children:"Válido desde"}),e.jsx(_,{children:e.jsx(b,{type:"date",...s,value:s.value||""})}),e.jsx(v,{})]})}),e.jsx(j,{control:i.control,name:"valid_until",render:({field:s})=>e.jsxs(g,{children:[e.jsx(m,{children:"Válido hasta"}),e.jsx(_,{children:e.jsx(b,{type:"date",...s,value:s.value||"",onChange:n=>s.onChange(n.target.value||null)})}),e.jsx(N,{children:"Dejar vacío para sin fecha límite"}),e.jsx(v,{})]})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(m,{children:"Aplicable a Bonos (opcional)"}),e.jsx(N,{children:"Si no seleccionas ningún bono, el cupón solo aplicará a reservas directas (sin bonos)"}),e.jsx("div",{className:"grid grid-cols-1 gap-3 p-4 border rounded-lg bg-muted/50",children:c.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No hay bonos disponibles"}):c.map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(oe,{id:`package-${s.id}`,checked:h.includes(s.id),onCheckedChange:n=>{p(o=>n?[...o,s.id]:o.filter(I=>I!==s.id))}}),e.jsxs("label",{htmlFor:`package-${s.id}`,className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer",children:[s.name," - $",s.price_clp.toLocaleString("es-CL")," (",s.sessions_quantity," sesiones)"]})]},s.id))})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(T,{type:"button",variant:"outline",onClick:w,disabled:y.isPending,className:"flex-1",children:"Cancelar"}),e.jsx(T,{type:"submit",disabled:y.isPending,className:"flex-1",children:y.isPending?e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"mr-2 h-4 w-4 animate-spin"}),"Guardando..."]}):x?"Actualizar":"Crear Cupón"})]})]})})]})})}function We(){const l=K(),[w,r]=F.useState(!1),[q,x]=F.useState(null),[h,p]=F.useState(null),{data:c,isLoading:i}=O({queryKey:["coupons-admin"],queryFn:async()=>{const{data:a,error:t}=await f.from("discount_coupons").select("*").order("created_at",{ascending:!1});if(t)throw t;return a}}),{data:y=[]}=O({queryKey:["session-packages-names"],queryFn:async()=>{const{data:a,error:t}=await f.from("session_packages").select("id, name").eq("is_active",!0);if(t)throw t;return a||[]}}),P=a=>!a||a.length===0?e.jsx("span",{className:"text-muted-foreground italic",children:"Solo reservas directas"}):a.map(C=>{var D;return(D=y.find(H=>H.id===C))==null?void 0:D.name}).filter(Boolean).join(", ")||e.jsx("span",{className:"text-muted-foreground",children:"—"}),k=V({mutationFn:async({id:a,isActive:t})=>{const{error:C}=await f.from("discount_coupons").update({is_active:t}).eq("id",a);if(C)throw C},onSuccess:()=>{l.invalidateQueries({queryKey:["coupons-admin"]}),S.success("Estado actualizado")},onError:()=>{S.error("Error al actualizar estado")}}),s=V({mutationFn:async a=>{const{error:t}=await f.from("discount_coupons").delete().eq("id",a);if(t)throw t},onSuccess:()=>{l.invalidateQueries({queryKey:["coupons-admin"]}),S.success("Cupón eliminado"),p(null)},onError:()=>{S.error("Error al eliminar cupón")}}),n=a=>{x(a),r(!0)},o=()=>{r(!1),x(null)},I=a=>{const t=new Date,C=new Date(a.valid_from),D=a.valid_until?new Date(a.valid_until):null;return a.is_active?t<C?e.jsx(E,{variant:"outline",children:"Programado"}):D&&t>D?e.jsx(E,{variant:"destructive",children:"Expirado"}):a.max_uses&&a.current_uses>=a.max_uses?e.jsx(E,{variant:"destructive",children:"Agotado"}):e.jsx(E,{className:"bg-green-500 hover:bg-green-600",children:"Activo"}):e.jsx(E,{variant:"secondary",children:"Inactivo"})};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Gestión de Cupones"}),e.jsxs(T,{onClick:()=>r(!0),children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Nuevo Cupón"]})]}),i?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(U,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsx(J,{children:e.jsx(W,{className:"p-0",children:e.jsxs(X,{children:[e.jsx(ee,{children:e.jsxs(M,{children:[e.jsx(u,{children:"Código"}),e.jsx(u,{children:"Descuento"}),e.jsx(u,{children:"Aplica a"}),e.jsx(u,{children:"Usos"}),e.jsx(u,{children:"Validez"}),e.jsx(u,{children:"Estado"}),e.jsx(u,{children:"Activo"}),e.jsx(u,{className:"text-right",children:"Acciones"})]})}),e.jsx(se,{children:(c==null?void 0:c.length)===0?e.jsx(M,{children:e.jsx(d,{colSpan:8,className:"text-center py-8 text-muted-foreground",children:"No hay cupones registrados"})}):c==null?void 0:c.map(a=>e.jsxs(M,{children:[e.jsx(d,{children:e.jsx("span",{className:"font-mono font-bold text-primary",children:a.code})}),e.jsx(d,{children:e.jsx("div",{className:"flex items-center gap-2",children:a.discount_type==="percentage"?e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{children:[a.discount_value,"%"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{children:["$",a.discount_value.toLocaleString("es-CL")]})]})})}),e.jsx(d,{children:e.jsx("div",{className:"text-sm max-w-xs truncate",children:P(a.applicable_package_ids)})}),e.jsx(d,{children:e.jsxs("span",{children:[a.current_uses,a.max_uses?` / ${a.max_uses}`:" / ∞"]})}),e.jsx(d,{children:e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{children:["Desde: ",B(new Date(a.valid_from),"dd/MM/yyyy",{locale:$})]}),a.valid_until&&e.jsxs("div",{children:["Hasta: ",B(new Date(a.valid_until),"dd/MM/yyyy",{locale:$})]})]})}),e.jsx(d,{children:I(a)}),e.jsx(d,{children:e.jsx(ce,{checked:a.is_active,onCheckedChange:t=>k.mutate({id:a.id,isActive:t})})}),e.jsx(d,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(T,{variant:"ghost",size:"sm",onClick:()=>n(a),children:e.jsx(Ne,{className:"h-4 w-4"})}),e.jsx(T,{variant:"ghost",size:"sm",onClick:()=>p(a.id),children:e.jsx(Se,{className:"h-4 w-4 text-destructive"})})]})})]},a.id))})]})})}),e.jsx(Ee,{open:w,onClose:o,coupon:q}),e.jsx(he,{open:!!h,onOpenChange:()=>p(null),children:e.jsxs(pe,{children:[e.jsxs(je,{children:[e.jsx(ge,{children:"¿Eliminar cupón?"}),e.jsx(_e,{children:"Esta acción no se puede deshacer. Se eliminará permanentemente el cupón."})]}),e.jsxs(ve,{children:[e.jsx(fe,{children:"Cancelar"}),e.jsx(ye,{onClick:()=>h&&s.mutate(h),className:"bg-destructive hover:bg-destructive/90",children:"Eliminar"})]})]})})]})}export{We as default};
