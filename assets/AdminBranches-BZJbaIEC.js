import{V as q,r as A,j as e,Y as B,Z as P,_ as I,$ as L,I as S,B as y,f as O,s as f,g as p}from"./index-DZgJ29pE.js";import{u as M}from"./useQuery-Cz2LeAXE.js";import{u as T}from"./useMutation-6KN3B1wo.js";import{C as Q,c as H}from"./card-B25bVudG.js";import{T as K,a as V,b as F,c as g,d as R,e as u}from"./table-BK2hRZHQ.js";import{u as $}from"./index.esm-kyqXXHc9.js";import{o as G,s as D,n as U,b,t as Y}from"./zod-DRmRFH-_.js";import{F as Z,a as m,b as x,c as h,d as j,e as C}from"./form-BAlrFiXM.js";import{T as J}from"./textarea-3DxZ9G3h.js";import{C as k,S as W}from"./switch-BAjtLQMz.js";import{A as X,b as ee,c as se,d as re,e as ae,f as ie,g as te,h as ne}from"./alert-dialog-3iDBAjjQ.js";import{B as le}from"./badge-DjURDUju.js";import{P as oe}from"./plus-DMAXOVpl.js";import{S as ce}from"./star-DOcb0H5e.js";import{P as de}from"./pencil-B3-WPuAv.js";import{T as ue}from"./trash-2-BmiBsQfa.js";import"./label-BeAyWXnA.js";import"./index-D1kiJhbx.js";import"./check-VtwSEAeH.js";const me=G({name:D().min(2,"El nombre debe tener al menos 2 caracteres"),slug:D().min(2,"El slug debe tener al menos 2 caracteres").regex(/^[a-z0-9-]+$/,"Solo letras minúsculas, números y guiones"),address:D().optional(),description:D().optional(),sortOrder:U().min(0,"Mínimo 0").default(0),isDefault:b().default(!1),isActive:b().default(!0)});function xe({open:N,onClose:v,branch:r}){const w=q(),o=!!r,i=$({resolver:Y(me),defaultValues:{name:"",slug:"",address:"",description:"",sortOrder:0,isDefault:!1,isActive:!0}});A.useEffect(()=>{r?i.reset({name:r.name,slug:r.slug,address:r.address||"",description:r.description||"",sortOrder:r.sort_order,isDefault:r.is_default,isActive:r.is_active}):i.reset({name:"",slug:"",address:"",description:"",sortOrder:0,isDefault:!1,isActive:!0})},[r,i]);const d=T({mutationFn:async s=>{const t={name:s.name,slug:s.slug,address:s.address||null,description:s.description||null,sort_order:s.sortOrder,is_default:s.isDefault,is_active:s.isActive};if(s.isDefault&&await f.from("branches").update({is_default:!1}).neq("id",(r==null?void 0:r.id)||""),o){const{error:n}=await f.from("branches").update(t).eq("id",r.id);if(n)throw n}else{const{error:n}=await f.from("branches").insert(t);if(n)throw n}},onSuccess:()=>{w.invalidateQueries({queryKey:["branches-admin"]}),p.success(o?"Sucursal actualizada":"Sucursal creada"),v()},onError:s=>{p.error(s.message||"Error al guardar sucursal")}}),c=s=>{d.mutate(s)},E=s=>{const t=s.target.value;if(i.setValue("name",t),!o||!(r!=null&&r.slug)){const n=t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");i.setValue("slug",n)}};return e.jsx(B,{open:N,onOpenChange:v,children:e.jsxs(P,{className:"sm:max-w-md",children:[e.jsx(I,{children:e.jsx(L,{children:o?"Editar Sucursal":"Nueva Sucursal"})}),e.jsx(Z,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit(c),className:"space-y-4",children:[e.jsx(m,{control:i.control,name:"name",render:({field:s})=>e.jsxs(x,{children:[e.jsx(h,{children:"Nombre"}),e.jsx(j,{children:e.jsx(S,{...s,placeholder:"Santiago Centro",onChange:E})}),e.jsx(C,{})]})}),e.jsx(m,{control:i.control,name:"slug",render:({field:s})=>e.jsxs(x,{children:[e.jsx(h,{children:"Slug (URL)"}),e.jsx(j,{children:e.jsx(S,{...s,placeholder:"santiago-centro"})}),e.jsx(C,{})]})}),e.jsx(m,{control:i.control,name:"address",render:({field:s})=>e.jsxs(x,{children:[e.jsx(h,{children:"Dirección"}),e.jsx(j,{children:e.jsx(S,{...s,placeholder:"Av. Providencia 123, Santiago"})}),e.jsx(C,{})]})}),e.jsx(m,{control:i.control,name:"description",render:({field:s})=>e.jsxs(x,{children:[e.jsx(h,{children:"Descripción (opcional)"}),e.jsx(j,{children:e.jsx(J,{...s,placeholder:"Descripción de la sucursal...",rows:3})}),e.jsx(C,{})]})}),e.jsx(m,{control:i.control,name:"sortOrder",render:({field:s})=>e.jsxs(x,{children:[e.jsx(h,{children:"Orden de visualización"}),e.jsx(j,{children:e.jsx(S,{...s,type:"number",onChange:t=>s.onChange(parseInt(t.target.value)||0),placeholder:"1 = primero"})}),e.jsx(C,{})]})}),e.jsxs("div",{className:"flex gap-6",children:[e.jsx(m,{control:i.control,name:"isDefault",render:({field:s})=>e.jsxs(x,{className:"flex items-center space-x-2",children:[e.jsx(j,{children:e.jsx(k,{checked:s.value,onCheckedChange:s.onChange})}),e.jsx(h,{className:"!mt-0",children:"Sucursal por defecto"})]})}),e.jsx(m,{control:i.control,name:"isActive",render:({field:s})=>e.jsxs(x,{className:"flex items-center space-x-2",children:[e.jsx(j,{children:e.jsx(k,{checked:s.value,onCheckedChange:s.onChange})}),e.jsx(h,{className:"!mt-0",children:"Activa"})]})})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(y,{type:"button",variant:"outline",onClick:v,children:"Cancelar"}),e.jsxs(y,{type:"submit",disabled:d.isPending,children:[d.isPending&&e.jsx(O,{className:"mr-2 h-4 w-4 animate-spin"}),o?"Actualizar":"Crear"]})]})]})})]})})}function qe(){const N=q(),[v,r]=A.useState(!1),[w,o]=A.useState(null),[i,d]=A.useState(null),{data:c,isLoading:E}=M({queryKey:["branches-admin"],queryFn:async()=>{const{data:a,error:l}=await f.from("branches").select("*").order("sort_order",{ascending:!0});if(l)throw l;return a}}),s=T({mutationFn:async({id:a,isActive:l})=>{const{error:_}=await f.from("branches").update({is_active:l}).eq("id",a);if(_)throw _},onSuccess:()=>{N.invalidateQueries({queryKey:["branches-admin"]}),p.success("Estado actualizado")},onError:()=>{p.error("Error al actualizar estado")}}),t=T({mutationFn:async a=>{const{error:l}=await f.from("branches").delete().eq("id",a);if(l)throw l},onSuccess:()=>{N.invalidateQueries({queryKey:["branches-admin"]}),p.success("Sucursal eliminada"),d(null)},onError:()=>{p.error("Error al eliminar sucursal. Puede que tenga servicios asociados.")}}),n=a=>{o(a),r(!0)},z=()=>{r(!1),o(null)};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Gestión de Sucursales"}),e.jsxs(y,{onClick:()=>r(!0),children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Nueva Sucursal"]})]}),E?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(O,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsx(Q,{children:e.jsx(H,{className:"p-0",children:e.jsxs(K,{children:[e.jsx(V,{children:e.jsxs(F,{children:[e.jsx(g,{children:"Orden"}),e.jsx(g,{children:"Nombre"}),e.jsx(g,{children:"Slug"}),e.jsx(g,{children:"Dirección"}),e.jsx(g,{children:"Activa"}),e.jsx(g,{className:"text-right",children:"Acciones"})]})}),e.jsx(R,{children:(c==null?void 0:c.length)===0?e.jsx(F,{children:e.jsx(u,{colSpan:6,className:"text-center py-8 text-muted-foreground",children:"No hay sucursales registradas"})}):c==null?void 0:c.map(a=>e.jsxs(F,{children:[e.jsx(u,{className:"text-foreground font-medium w-16",children:a.sort_order}),e.jsx(u,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:a.name}),a.is_default&&e.jsxs(le,{variant:"secondary",className:"gap-1",children:[e.jsx(ce,{className:"h-3 w-3"}),"Por defecto"]})]})}),e.jsx(u,{className:"text-muted-foreground",children:a.slug}),e.jsx(u,{className:"text-foreground",children:a.address||"-"}),e.jsx(u,{children:e.jsx(W,{checked:a.is_active,onCheckedChange:l=>s.mutate({id:a.id,isActive:l})})}),e.jsx(u,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>n(a),children:e.jsx(de,{className:"h-4 w-4"})}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>d(a.id),disabled:a.is_default,children:e.jsx(ue,{className:"h-4 w-4 text-destructive"})})]})})]},a.id))})]})})}),e.jsx(xe,{open:v,onClose:z,branch:w}),e.jsx(X,{open:!!i,onOpenChange:()=>d(null),children:e.jsxs(ee,{children:[e.jsxs(se,{children:[e.jsx(re,{children:"¿Eliminar sucursal?"}),e.jsx(ae,{children:"Esta acción no se puede deshacer. Se eliminará permanentemente la sucursal. Asegúrate de reasignar los servicios asociados primero."})]}),e.jsxs(ie,{children:[e.jsx(te,{children:"Cancelar"}),e.jsx(ne,{onClick:()=>i&&t.mutate(i),className:"bg-destructive hover:bg-destructive/90",children:"Eliminar"})]})]})})]})}export{qe as default};
