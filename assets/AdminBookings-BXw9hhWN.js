import{c as D,ah as W,V as ee,r as o,j as e,I as se,f as w,B as x,s as _,g as h}from"./index-D2jBbZS7.js";import{u as R}from"./useQuery-B-fiS_pv.js";import{u as I}from"./useMutation-DhgzXs9Y.js";import{T as ae,a as re,b as S,c as l,d as te,e as n}from"./table-DKjfbaBy.js";import{B as A}from"./badge-CKfv1vdZ.js";import{S as q,a as B,b as O,c as H,d as i}from"./select-DhA8D-pX.js";import{C as $,a as ne,b as le,c as U}from"./card-OYLB4Vmq.js";import{A as oe,a as ce,b as ie,c as de,d as me,e as ue,f as xe,g as he,h as je}from"./alert-dialog-DuN13zaQ.js";import{S as pe}from"./search-DeJMuAO-.js";import{f as z}from"./index-Cj0rGzeA.js";import{C as fe}from"./circle-x-B3hxBext.js";import{C as ge,a as ve}from"./chevron-right-DIT06g0N.js";import{n as G}from"./es-BGq_Vek6.js";import"./index-DuNgS-Bs.js";import"./index-q10XEKNx.js";import"./chevron-down-FFjHraMF.js";import"./chevron-up-FXiSCfMY.js";import"./check-DlvlGAKd.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=D("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=D("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=D("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]),Ee={PENDING_PAYMENT:"bg-yellow-500",CONFIRMED:"bg-green-500",CANCELLED:"bg-red-500",COMPLETED:"bg-blue-500"},we={PENDING_PAYMENT:"Pendiente Pago",CONFIRMED:"Confirmada",CANCELLED:"Cancelada",COMPLETED:"Completada"};function ze(){var T,F;const{session:c}=W(),M=ee(),[m,v]=o.useState(1),[j,V]=o.useState("all"),[p,Y]=o.useState("all"),[P,k]=o.useState(""),[N,K]=o.useState(""),[f,Q]=o.useState("created_at"),[g,b]=o.useState("desc");o.useState(()=>{const s=setTimeout(()=>{K(P)},500);return()=>clearTimeout(s)});const{data:t,isLoading:X}=R({queryKey:["admin-bookings",m,j,p,N,f,g],queryFn:async()=>{const s=new URLSearchParams({page:m.toString(),limit:"20",sortBy:f,sortOrder:g});j!=="all"&&s.append("status",j),p!=="all"&&s.append("professionalId",p),N&&s.append("search",N);const r=`https://pyupvlgdtcxgqjungiof.supabase.co/functions/v1/admin-bookings?${s.toString()}`,d=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${c==null?void 0:c.access_token}`,"Content-Type":"application/json"}});if(!d.ok){const J=await d.json();throw new Error(J.error||"Error fetching bookings")}const L=await d.json();return console.log("Admin bookings response:",L),L},enabled:!!c}),{data:C}=R({queryKey:["professionals"],queryFn:async()=>{const{data:s,error:a}=await _.from("professionals").select("*").eq("is_active",!0);if(a)throw a;return s}}),y=I({mutationFn:async s=>{console.log("Confirming booking:",s),console.log("Session token available:",!!(c!=null&&c.access_token));const{data:a,error:r}=await _.functions.invoke("admin-bookings",{body:{id:s,status:"CONFIRMED"}});if(console.log("Response data:",a),console.log("Response error:",r),r)throw console.error("Function invoke error:",r),new Error(r.message||"Error al confirmar reserva");return a},onSuccess:s=>{console.log("Confirmation successful:",s),M.invalidateQueries({queryKey:["admin-bookings"]}),h.success("Reserva confirmada y email enviado al cliente")},onError:s=>{console.error("Mutation error:",s),h.error(`Error al confirmar: ${s.message}`)}}),E=I({mutationFn:async s=>{console.log("Cancel and release for booking:",s);const{data:a,error:r}=await _.functions.invoke("admin-bookings",{body:{id:s,action:"cancel_and_release"}});if(r)throw console.error("Function invoke error:",r),new Error(r.message||"Error al cancelar reserva");return a},onSuccess:s=>{console.log("Cancel and release successful:",s),M.invalidateQueries({queryKey:["admin-bookings"]}),s.code_released?h.success(`Reserva cancelada y cÃ³digo ${s.code_released} liberado`):h.success("Reserva cancelada exitosamente")},onError:s=>{console.error("Mutation error:",s),h.error(`Error al cancelar: ${s.message}`)}}),Z=s=>{f===s?b(g==="asc"?"desc":"asc"):(Q(s),b("desc")),v(1)},u=({column:s,label:a})=>e.jsxs(x,{variant:"ghost",size:"sm",onClick:()=>Z(s),className:"h-8 px-2 lg:px-3",children:[a,f===s?g==="asc"?e.jsx(ye,{className:"ml-2 h-4 w-4"}):e.jsx(Ne,{className:"ml-2 h-4 w-4"}):e.jsx(Ce,{className:"ml-2 h-4 w-4"})]});return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"GestiÃ³n de Reservas"})}),e.jsxs($,{children:[e.jsx(ne,{children:e.jsx(le,{children:"Filtros"})}),e.jsx(U,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(pe,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(se,{placeholder:"Buscar por nombre, email o telÃ©fono...",value:P,onChange:s=>k(s.target.value),className:"pl-10"})]})}),e.jsxs(q,{value:p,onValueChange:Y,children:[e.jsx(B,{className:"w-full sm:w-48",children:e.jsx(O,{placeholder:"Instructor"})}),e.jsxs(H,{children:[e.jsx(i,{value:"all",children:"Todos los instructores"}),C==null?void 0:C.map(s=>e.jsx(i,{value:s.id,children:s.name},s.id))]})]}),e.jsxs(q,{value:j,onValueChange:V,children:[e.jsx(B,{className:"w-full sm:w-48",children:e.jsx(O,{placeholder:"Estado"})}),e.jsxs(H,{children:[e.jsx(i,{value:"all",children:"Todos los estados"}),e.jsx(i,{value:"PENDING_PAYMENT",children:"Pendiente Pago"}),e.jsx(i,{value:"CONFIRMED",children:"Confirmada"}),e.jsx(i,{value:"CANCELLED",children:"Cancelada"}),e.jsx(i,{value:"COMPLETED",children:"Completada"})]})]})]})})]}),X?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(w,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsx($,{children:e.jsx(U,{className:"p-0",children:e.jsxs(ae,{children:[e.jsx(re,{children:e.jsxs(S,{children:[e.jsx(l,{children:e.jsx(u,{column:"created_at",label:"Fecha de Pago"})}),e.jsx(l,{children:e.jsx(u,{column:"customer_name",label:"Cliente"})}),e.jsx(l,{children:"Instructor"}),e.jsx(l,{children:"Servicio"}),e.jsx(l,{children:e.jsx(u,{column:"date_time_start",label:"Fecha y Hora SesiÃ³n"})}),e.jsx(l,{children:e.jsx(u,{column:"status",label:"Estado"})}),e.jsx(l,{children:e.jsx(u,{column:"final_price",label:"Precio"})}),e.jsx(l,{children:"CupÃ³n/CÃ³digo"}),e.jsx(l,{children:"Acciones"})]})}),e.jsx(te,{children:((T=t==null?void 0:t.bookings)==null?void 0:T.length)===0?e.jsx(S,{children:e.jsx(n,{colSpan:9,className:"text-center py-8 text-muted-foreground",children:"No se encontraron reservas"})}):(F=t==null?void 0:t.bookings)==null?void 0:F.map(s=>{var a,r,d;return e.jsxs(S,{children:[e.jsx(n,{className:"text-foreground",children:z(s.created_at,"America/Santiago","d 'de' MMM, yyyy HH:mm",{locale:G})}),e.jsx(n,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-foreground",children:s.customer_name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.customer_email}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.customer_phone})]})}),e.jsx(n,{className:"text-foreground",children:s.professionals.name}),e.jsx(n,{className:"text-foreground",children:s.services.name}),e.jsx(n,{className:"text-foreground",children:z(s.date_time_start,"America/Santiago","d 'de' MMMM, yyyy 'a las' HH:mm",{locale:G})}),e.jsx(n,{children:e.jsx(A,{className:Ee[s.status],children:we[s.status]})}),e.jsx(n,{className:"text-foreground font-medium",children:s.discount_amount&&s.discount_amount>0?e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"line-through text-muted-foreground text-sm",children:["$",(a=s.original_price)==null?void 0:a.toLocaleString("es-CL")]}),e.jsxs("span",{className:"text-green-600 font-semibold",children:["$",(r=s.final_price)==null?void 0:r.toLocaleString("es-CL")]})]}):e.jsxs("span",{children:["$",s.services.price_clp.toLocaleString("es-CL")]})}),e.jsx(n,{children:s.session_codes?e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs(A,{variant:"outline",className:"font-mono text-xs border-primary text-primary",children:["ðŸŽŸï¸ ",s.session_codes.code]}),((d=s.session_codes.session_packages)==null?void 0:d.name)&&e.jsx("span",{className:"text-xs text-muted-foreground",children:s.session_codes.session_packages.name})]}):s.discount_coupons?e.jsxs(A,{variant:"secondary",className:"font-mono text-xs",children:["ðŸ·ï¸ ",s.discount_coupons.code]}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"-"})}),e.jsx(n,{children:e.jsxs("div",{className:"flex flex-col gap-2",children:[s.status==="PENDING_PAYMENT"&&e.jsx(x,{size:"sm",variant:"default",onClick:()=>y.mutate(s.id),disabled:y.isPending,children:y.isPending?e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"h-4 w-4 mr-2 animate-spin"}),"Confirmando..."]}):"Confirmar Manualmente"}),(s.status==="CONFIRMED"||s.status==="PENDING_PAYMENT")&&e.jsxs(oe,{children:[e.jsx(ce,{asChild:!0,children:e.jsx(x,{size:"sm",variant:"destructive",disabled:E.isPending,children:E.isPending?e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"h-4 w-4 mr-2 animate-spin"}),"Cancelando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"h-4 w-4 mr-1"}),s.session_codes?"Cancelar y Liberar CÃ³digo":"Cancelar Reserva"]})})}),e.jsxs(ie,{children:[e.jsxs(de,{children:[e.jsx(me,{children:"Â¿Cancelar esta reserva?"}),e.jsx(ue,{children:s.session_codes?e.jsxs(e.Fragment,{children:["Esta acciÃ³n cancelarÃ¡ la reserva de ",e.jsx("strong",{children:s.customer_name})," y liberarÃ¡ el cÃ³digo ",e.jsx("strong",{className:"font-mono",children:s.session_codes.code})," para que pueda ser utilizado nuevamente."]}):e.jsxs(e.Fragment,{children:["Esta acciÃ³n cancelarÃ¡ la reserva de ",e.jsx("strong",{children:s.customer_name}),". Esta acciÃ³n no se puede deshacer."]})})]}),e.jsxs(xe,{children:[e.jsx(he,{children:"No, mantener reserva"}),e.jsxs(je,{onClick:()=>E.mutate(s.id),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:["SÃ­, cancelar",s.session_codes?" y liberar cÃ³digo":""]})]})]})]})]})})]},s.id)})})]})})}),t&&t.totalPages>1&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["PÃ¡gina ",m," de ",t.totalPages]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>v(s=>Math.max(1,s-1)),disabled:m===1,children:[e.jsx(ge,{className:"h-4 w-4"}),"Anterior"]}),e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>v(s=>s+1),disabled:m>=t.totalPages,children:["Siguiente",e.jsx(ve,{className:"h-4 w-4"})]})]})]})]})]})}export{ze as default};
