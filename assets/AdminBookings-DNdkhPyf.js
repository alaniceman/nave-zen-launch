import{c as D,ai as J,W as ee,r as c,j as e,I as se,f as w,B as h,s as E,g as m}from"./index-CghTuXSA.js";import{u as R}from"./useQuery-CPKM8Efw.js";import{u as I}from"./useMutation-C6tOpZqe.js";import{T as ae,a as re,b as S,c as l,d as te,e as n}from"./table-BqTCIGy7.js";import{B as A}from"./badge-DbuPl21f.js";import{S as q,a as B,b as O,c as $,d as i}from"./select-BwfeUlwA.js";import{C as H,a as ne,b as le,c as G}from"./card-Cwf63ns9.js";import{A as ce,a as oe,b as ie,c as de,d as me,e as ue,f as xe,g as he,h as je}from"./alert-dialog-cZClnN5T.js";import{S as pe}from"./search-C918BH_s.js";import{f as U}from"./index-Cj0rGzeA.js";import{C as fe}from"./circle-x-DnVuZOEE.js";import{C as ge,a as ve}from"./chevron-right-BQ2XUsn5.js";import{n as z}from"./es-BGq_Vek6.js";import"./index-dHkOALWp.js";import"./index-BD-JhW_R.js";import"./chevron-up-DgePb_dF.js";import"./check-CjQzBIcr.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=D("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=D("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=D("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]),_e={PENDING_PAYMENT:"bg-yellow-500",CONFIRMED:"bg-green-500",CANCELLED:"bg-red-500",COMPLETED:"bg-blue-500"},we={PENDING_PAYMENT:"Pendiente Pago",CONFIRMED:"Confirmada",CANCELLED:"Cancelada",COMPLETED:"Completada"};function Ge(){var T,F;const{session:o}=J(),M=ee(),[u,v]=c.useState(1),[j,V]=c.useState("all"),[p,Y]=c.useState("all"),[P,K]=c.useState(""),[N,Q]=c.useState(""),[f,k]=c.useState("created_at"),[g,b]=c.useState("desc");c.useState(()=>{const s=setTimeout(()=>{Q(P)},500);return()=>clearTimeout(s)});const{data:t,isLoading:W}=R({queryKey:["admin-bookings",u,j,p,N,f,g],queryFn:async()=>{const s=new URLSearchParams({page:u.toString(),limit:"20",sortBy:f,sortOrder:g});j!=="all"&&s.append("status",j),p!=="all"&&s.append("professionalId",p),N&&s.append("search",N);const r=`https://pyupvlgdtcxgqjungiof.supabase.co/functions/v1/admin-bookings?${s.toString()}`,d=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${o==null?void 0:o.access_token}`,"Content-Type":"application/json"}});if(!d.ok){const Z=await d.json();throw new Error(Z.error||"Error fetching bookings")}const L=await d.json();return console.log("Admin bookings response:",L),L},enabled:!!o}),{data:C}=R({queryKey:["professionals"],queryFn:async()=>{const{data:s,error:a}=await E.from("professionals").select("*").eq("is_active",!0);if(a)throw a;return s}}),y=I({mutationFn:async s=>{console.log("Confirming booking:",s),console.log("Session token available:",!!(o!=null&&o.access_token));const{data:a,error:r}=await E.functions.invoke("admin-bookings",{body:{id:s,status:"CONFIRMED"}});if(console.log("Response data:",a),console.log("Response error:",r),r)throw console.error("Function invoke error:",r),new Error(r.message||"Error al confirmar reserva");return a},onSuccess:s=>{console.log("Confirmation successful:",s),M.invalidateQueries({queryKey:["admin-bookings"]}),m.success("Reserva confirmada y email enviado al cliente")},onError:s=>{console.error("Mutation error:",s),m.error(`Error al confirmar: ${s.message}`)}}),_=I({mutationFn:async s=>{console.log("Cancel and release for booking:",s);const{data:a,error:r}=await E.functions.invoke("admin-bookings",{body:{id:s,action:"cancel_and_release"}});if(r)throw console.error("Function invoke error:",r),new Error(r.message||"Error al cancelar reserva");return a},onSuccess:s=>{console.log("Cancel and release successful:",s),M.invalidateQueries({queryKey:["admin-bookings"]}),s.code_created?m.success(`Reserva cancelada y cÃ³digo ${s.code_created} creado y enviado al cliente`):s.code_released?m.success(`Reserva cancelada y cÃ³digo ${s.code_released} liberado`):m.success("Reserva cancelada exitosamente")},onError:s=>{console.error("Mutation error:",s),m.error(`Error al cancelar: ${s.message}`)}}),X=s=>{f===s?b(g==="asc"?"desc":"asc"):(k(s),b("desc")),v(1)},x=({column:s,label:a})=>e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>X(s),className:"h-8 px-2 lg:px-3",children:[a,f===s?g==="asc"?e.jsx(ye,{className:"ml-2 h-4 w-4"}):e.jsx(Ne,{className:"ml-2 h-4 w-4"}):e.jsx(Ce,{className:"ml-2 h-4 w-4"})]});return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"GestiÃ³n de Reservas"})}),e.jsxs(H,{children:[e.jsx(ne,{children:e.jsx(le,{children:"Filtros"})}),e.jsx(G,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(pe,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(se,{placeholder:"Buscar por nombre, email o telÃ©fono...",value:P,onChange:s=>K(s.target.value),className:"pl-10"})]})}),e.jsxs(q,{value:p,onValueChange:Y,children:[e.jsx(B,{className:"w-full sm:w-48",children:e.jsx(O,{placeholder:"Instructor"})}),e.jsxs($,{children:[e.jsx(i,{value:"all",children:"Todos los instructores"}),C==null?void 0:C.map(s=>e.jsx(i,{value:s.id,children:s.name},s.id))]})]}),e.jsxs(q,{value:j,onValueChange:V,children:[e.jsx(B,{className:"w-full sm:w-48",children:e.jsx(O,{placeholder:"Estado"})}),e.jsxs($,{children:[e.jsx(i,{value:"all",children:"Todos los estados"}),e.jsx(i,{value:"PENDING_PAYMENT",children:"Pendiente Pago"}),e.jsx(i,{value:"CONFIRMED",children:"Confirmada"}),e.jsx(i,{value:"CANCELLED",children:"Cancelada"}),e.jsx(i,{value:"COMPLETED",children:"Completada"})]})]})]})})]}),W?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(w,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsx(H,{children:e.jsx(G,{className:"p-0",children:e.jsxs(ae,{children:[e.jsx(re,{children:e.jsxs(S,{children:[e.jsx(l,{children:e.jsx(x,{column:"created_at",label:"Fecha de Pago"})}),e.jsx(l,{children:e.jsx(x,{column:"customer_name",label:"Cliente"})}),e.jsx(l,{children:"Instructor"}),e.jsx(l,{children:"Servicio"}),e.jsx(l,{children:e.jsx(x,{column:"date_time_start",label:"Fecha y Hora SesiÃ³n"})}),e.jsx(l,{children:e.jsx(x,{column:"status",label:"Estado"})}),e.jsx(l,{children:e.jsx(x,{column:"final_price",label:"Precio"})}),e.jsx(l,{children:"CupÃ³n/CÃ³digo"}),e.jsx(l,{children:"Acciones"})]})}),e.jsx(te,{children:((T=t==null?void 0:t.bookings)==null?void 0:T.length)===0?e.jsx(S,{children:e.jsx(n,{colSpan:9,className:"text-center py-8 text-muted-foreground",children:"No se encontraron reservas"})}):(F=t==null?void 0:t.bookings)==null?void 0:F.map(s=>{var a,r,d;return e.jsxs(S,{children:[e.jsx(n,{className:"text-foreground",children:U(s.created_at,"America/Santiago","d 'de' MMM, yyyy HH:mm",{locale:z})}),e.jsx(n,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-foreground",children:s.customer_name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.customer_email}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.customer_phone})]})}),e.jsx(n,{className:"text-foreground",children:s.professionals.name}),e.jsx(n,{className:"text-foreground",children:s.services.name}),e.jsx(n,{className:"text-foreground",children:U(s.date_time_start,"America/Santiago","d 'de' MMMM, yyyy 'a las' HH:mm",{locale:z})}),e.jsx(n,{children:e.jsx(A,{className:_e[s.status],children:we[s.status]})}),e.jsx(n,{className:"text-foreground font-medium",children:s.discount_amount&&s.discount_amount>0?e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"line-through text-muted-foreground text-sm",children:["$",(a=s.original_price)==null?void 0:a.toLocaleString("es-CL")]}),e.jsxs("span",{className:"text-green-600 font-semibold",children:["$",(r=s.final_price)==null?void 0:r.toLocaleString("es-CL")]})]}):e.jsxs("span",{children:["$",s.services.price_clp.toLocaleString("es-CL")]})}),e.jsx(n,{children:s.session_codes?e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs(A,{variant:"outline",className:"font-mono text-xs border-primary text-primary",children:["ðŸŽŸï¸ ",s.session_codes.code]}),((d=s.session_codes.session_packages)==null?void 0:d.name)&&e.jsx("span",{className:"text-xs text-muted-foreground",children:s.session_codes.session_packages.name})]}):s.discount_coupons?e.jsxs(A,{variant:"secondary",className:"font-mono text-xs",children:["ðŸ·ï¸ ",s.discount_coupons.code]}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"-"})}),e.jsx(n,{children:e.jsxs("div",{className:"flex flex-col gap-2",children:[s.status==="PENDING_PAYMENT"&&e.jsx(h,{size:"sm",variant:"default",onClick:()=>y.mutate(s.id),disabled:y.isPending,children:y.isPending?e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"h-4 w-4 mr-2 animate-spin"}),"Confirmando..."]}):"Confirmar Manualmente"}),(s.status==="CONFIRMED"||s.status==="PENDING_PAYMENT")&&e.jsxs(ce,{children:[e.jsx(oe,{asChild:!0,children:e.jsx(h,{size:"sm",variant:"destructive",disabled:_.isPending,children:_.isPending?e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"h-4 w-4 mr-2 animate-spin"}),"Cancelando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"h-4 w-4 mr-1"}),s.session_codes?"Cancelar y Liberar CÃ³digo":"Cancelar y Generar CÃ³digo"]})})}),e.jsxs(ie,{children:[e.jsxs(de,{children:[e.jsx(me,{children:"Â¿Cancelar esta reserva?"}),e.jsx(ue,{children:s.session_codes?e.jsxs(e.Fragment,{children:["Esta acciÃ³n cancelarÃ¡ la reserva de ",e.jsx("strong",{children:s.customer_name})," y liberarÃ¡ el cÃ³digo ",e.jsx("strong",{className:"font-mono",children:s.session_codes.code})," para que pueda ser utilizado nuevamente."]}):e.jsxs(e.Fragment,{children:["Esta acciÃ³n cancelarÃ¡ la reserva de ",e.jsx("strong",{children:s.customer_name})," y generarÃ¡ un cÃ³digo de sesiÃ³n de recuperaciÃ³n que serÃ¡ enviado a su correo (",e.jsx("strong",{children:s.customer_email}),")."]})})]}),e.jsxs(xe,{children:[e.jsx(he,{children:"No, mantener reserva"}),e.jsxs(je,{onClick:()=>_.mutate(s.id),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:["SÃ­, cancelar",s.session_codes?" y liberar cÃ³digo":" y generar cÃ³digo"]})]})]})]})]})})]},s.id)})})]})})}),t&&t.totalPages>1&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["PÃ¡gina ",u," de ",t.totalPages]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>v(s=>Math.max(1,s-1)),disabled:u===1,children:[e.jsx(ge,{className:"h-4 w-4"}),"Anterior"]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>v(s=>s+1),disabled:u>=t.totalPages,children:["Siguiente",e.jsx(ve,{className:"h-4 w-4"})]})]})]})]})]})}export{Ge as default};
