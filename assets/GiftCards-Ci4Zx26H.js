import{d as K,r as n,s as g,g as u,j as e,H as X,L as Z,f as N,I as j,B as C}from"./index-DObZXVZK.js";import{u as ee}from"./index.esm-CrozEuAs.js";import{o as se,s as w,t as re}from"./zod-BlJKHOjR.js";import{C as T}from"./card-Cqd1yrOM.js";import{L as b}from"./label-I2vmIKuX.js";import{F as ae}from"./Footer-D_7M5fB_.js";import{P as te}from"./PurchaseFAQ-Zi8L7kcD.js";import{u as ie}from"./useFacebookConversionsAPI-BYPG_mTH.js";import{G as x}from"./gift-CKQL7o-C.js";import{C as ne}from"./circle-check-Dge8OGqY.js";import{C as oe}from"./calendar-DaCyor-b.js";import"./accordion-NJzuYWx0.js";import"./index-2SUt3H7s.js";const ce=se({buyerName:w().min(2,"El nombre debe tener al menos 2 caracteres").max(100),buyerEmail:w().email("Email invÃ¡lido").max(255),buyerPhone:w().min(8,"TelÃ©fono invÃ¡lido").max(20)});function Ne(){var k,$;const{trackEvent:S}=K(),{trackServerEvent:_}=ie(),[o,q]=n.useState([]),[E,V]=n.useState([]),[t,A]=n.useState(null),[D,M]=n.useState(!0),[c,P]=n.useState(!1);n.useEffect(()=>{const s=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;S("ViewContent",{content_name:"Gift Cards",content_category:"GiftCard"},s),_({eventName:"ViewContent",eventId:s,contentName:"Gift Cards"}).catch(()=>{})},[]);const[p,L]=n.useState(""),[a,h]=n.useState(null),[G,f]=n.useState(""),[v,I]=n.useState(!1),{register:y,handleSubmit:R,formState:{errors:l}}=ee({resolver:re(ce)}),B=s=>{A(s),window.innerWidth<768&&setTimeout(()=>{var r;(r=document.getElementById("purchase-form"))==null||r.scrollIntoView({behavior:"smooth",block:"start"})},100)};n.useEffect(()=>{H(),O()},[]);const H=async()=>{try{const{data:s,error:r}=await g.from("session_packages").select("*").eq("is_active",!0).eq("available_as_giftcard",!0).order("sessions_quantity",{ascending:!0});if(r)throw r;q(s||[])}catch(s){console.error("Error loading packages:",s),u.error("Error al cargar los paquetes")}finally{M(!1)}},O=async()=>{try{const{data:s,error:r}=await g.from("services").select("id, name, price_clp").eq("is_active",!0);if(r)throw r;V(s||[])}catch(s){console.error("Error loading services:",s)}},Q=s=>{const r=E.filter(d=>s.applicable_service_ids.includes(d.id));if(r.length===0)return 0;const i=r.reduce((d,Y)=>d+Y.price_clp,0)/r.length*s.sessions_quantity;return Math.floor(i-s.price_clp)},z=s=>E.filter(r=>s.includes(r.id)).map(r=>r.name).join(", "),U=async()=>{if(!(!p.trim()||!t)){I(!0),f(""),h(null);try{const s=o.find(i=>i.id===t),{data:r,error:m}=await g.functions.invoke("validate-coupon",{body:{code:p.toUpperCase(),packageId:t,purchaseAmount:s==null?void 0:s.price_clp}});if(m||!(r!=null&&r.valid)){f((r==null?void 0:r.error)||"CupÃ³n no encontrado");return}h(r.coupon),u.success("Â¡CupÃ³n aplicado!")}catch(s){console.error("Error validating coupon:",s),f("Error al validar cupÃ³n")}finally{I(!1)}}},F=s=>{if(!a)return s;let r=0;return a.discount_type==="percentage"?r=Math.floor(s*(a.discount_value/100)):r=a.discount_value,Math.max(0,s-r)},W=s=>a?s-F(s):0,J=async s=>{if(!t){u.error("Selecciona una Gift Card");return}const r=o.find(i=>i.id===t),m=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;S("InitiateCheckout",{content_name:(r==null?void 0:r.name)||"Gift Card",currency:"CLP",value:(r==null?void 0:r.price_clp)||0},m),_({eventName:"InitiateCheckout",eventId:m,userEmail:s.buyerEmail,userName:s.buyerName,userPhone:s.buyerPhone,contentName:(r==null?void 0:r.name)||"Gift Card",value:(r==null?void 0:r.price_clp)||0,currency:"CLP"}).catch(()=>{}),P(!0);try{const{data:i,error:d}=await g.functions.invoke("purchase-session-package",{body:{packageId:t,couponCode:a==null?void 0:a.code,isGiftCard:!0,...s}});if(d)throw new Error(d.message||"Error al procesar la compra");if(i.freeOrder){u.success("Â¡Compra completada! Revisa tu email para obtener tus cÃ³digos."),window.location.href="/bonos/success?free=true";return}if(i.initPoint)window.location.href=i.initPoint;else throw new Error("No se pudo generar el link de pago")}catch(i){console.error("Error purchasing gift card:",i),u.error(i.message||"Error al procesar la compra"),P(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(X,{children:[e.jsx("title",{children:"Gift Cards - Studio La Nave"}),e.jsx("meta",{name:"description",content:"Regala experiencias Ãºnicas con las Gift Cards de Studio La Nave. Yoga, MÃ©todo Wim Hof, Ice Bath y mÃ¡s."})]}),e.jsx("main",{className:"min-h-screen pt-24 pb-16 px-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-12",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 mb-4",children:e.jsx(x,{className:"h-8 w-8 text-primary"})}),e.jsx("h1",{className:"text-4xl md:text-5xl font-bold mb-4",children:"Gift Cards"}),e.jsxs("p",{className:"text-lg text-muted-foreground max-w-2xl mx-auto",children:["Regala un pack de sesiones. Quien lo reciba obtendrÃ¡ los cÃ³digos y podrÃ¡ reservar cuando quiera en nuestra"," ",e.jsx(Z,{to:"/agenda-nave-studio",className:"text-primary hover:underline font-medium",children:"agenda"}),"."]})]}),D?e.jsx("div",{className:"flex justify-center items-center py-20",children:e.jsx(N,{className:"h-8 w-8 animate-spin"})}):o.length===0?e.jsxs("div",{className:"text-center py-20",children:[e.jsx(x,{className:"h-16 w-16 mx-auto text-muted-foreground mb-4"}),e.jsx("h2",{className:"text-2xl font-semibold mb-2",children:"PrÃ³ximamente"}),e.jsx("p",{className:"text-muted-foreground",children:"Estamos preparando las Gift Cards. Â¡Vuelve pronto!"})]}):e.jsxs("div",{className:"grid md:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Elige tu Gift Card"}),o.map(s=>{const r=Q(s);return e.jsx(T,{className:`p-6 cursor-pointer transition-all ${t===s.id?"border-primary shadow-lg ring-2 ring-primary/20":"hover:shadow-md"}`,onClick:()=>B(s.id),children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(x,{className:"h-5 w-5 text-primary"}),e.jsx("h3",{className:"text-xl font-bold",children:s.name})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:s.description}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-4 w-4 text-green-600"}),e.jsxs("span",{children:[s.sessions_quantity," sesiones"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{children:["VÃ¡lido por ",s.validity_days," dÃ­as"]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["VÃ¡lido para: ",z(s.applicable_service_ids)]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-2xl font-bold text-primary",children:["$",s.price_clp.toLocaleString("es-CL")]}),r>0&&e.jsxs("p",{className:"text-xs text-green-600 font-semibold mt-1",children:["Ahorra $",r.toLocaleString("es-CL")]})]})]})},s.id)})]}),e.jsx("div",{id:"purchase-form",children:e.jsxs(T,{className:"p-6 sticky top-24",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Tus datos"}),!t&&e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(x,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Selecciona una Gift Card para continuar"})]}),t&&e.jsxs("form",{onSubmit:R(J),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(b,{htmlFor:"buyerName",children:"Tu nombre *"}),e.jsx(j,{id:"buyerName",...y("buyerName"),placeholder:"Juan PÃ©rez",disabled:c}),l.buyerName&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:l.buyerName.message})]}),e.jsxs("div",{children:[e.jsx(b,{htmlFor:"buyerEmail",children:"Tu email *"}),e.jsx(j,{id:"buyerEmail",type:"email",...y("buyerEmail"),placeholder:"juan@ejemplo.com",disabled:c}),l.buyerEmail&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:l.buyerEmail.message}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"RecibirÃ¡s el link para descargar la Gift Card"})]}),e.jsxs("div",{children:[e.jsx(b,{htmlFor:"buyerPhone",children:"Tu celular *"}),e.jsx(j,{id:"buyerPhone",...y("buyerPhone"),placeholder:"+56912345678",disabled:c}),l.buyerPhone&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:l.buyerPhone.message})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx(b,{htmlFor:"couponCode",children:"Â¿Tienes un cÃ³digo de descuento?"}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx(j,{id:"couponCode",value:p,onChange:s=>{L(s.target.value.toUpperCase()),f(""),h(null)},placeholder:"CODIGO",className:"font-mono uppercase",disabled:c||v||!!a}),!a&&e.jsx(C,{type:"button",variant:"outline",onClick:U,disabled:!p.trim()||v||c,children:v?e.jsx(N,{className:"h-4 w-4 animate-spin"}):"Aplicar"}),a&&e.jsx(C,{type:"button",variant:"ghost",onClick:()=>{h(null),L("")},disabled:c,children:"Quitar"})]}),G&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:G}),a&&e.jsxs("div",{className:"mt-3 p-3 bg-green-50 dark:bg-green-950/20 rounded-lg border border-green-200 dark:border-green-900",children:[e.jsxs("p",{className:"text-sm font-semibold text-green-700 dark:text-green-400",children:["âœ“ CupÃ³n ",a.code," aplicado"]}),e.jsx("p",{className:"text-xs text-green-600 dark:text-green-500 mt-1",children:a.discount_type==="percentage"?`-${a.discount_value}%`:`-$${a.discount_value.toLocaleString("es-CL")}`})]})]}),t&&a&&e.jsxs("div",{className:"bg-muted/50 rounded-lg p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground line-through",children:"Precio original:"}),e.jsxs("span",{className:"text-muted-foreground line-through",children:["$",(k=o.find(s=>s.id===t))==null?void 0:k.price_clp.toLocaleString("es-CL")]})]}),e.jsxs("div",{className:"flex justify-between text-sm text-green-600 dark:text-green-400",children:[e.jsx("span",{children:"Descuento:"}),e.jsxs("span",{children:["-$",W(o.find(s=>s.id===t).price_clp).toLocaleString("es-CL")]})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t pt-2",children:[e.jsx("span",{children:"Total a pagar:"}),e.jsxs("span",{className:"text-primary",children:["$",F(o.find(s=>s.id===t).price_clp).toLocaleString("es-CL")]})]})]}),e.jsxs("div",{className:"bg-primary/5 rounded-lg p-4 space-y-2 border border-primary/20",children:[e.jsx("p",{className:"text-sm font-medium",children:"ðŸŽ CÃ³mo funciona"}),e.jsxs("ul",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("li",{children:"â€¢ RecibirÃ¡s un email con el link para descargar tu Gift Card"}),e.jsx("li",{children:"â€¢ PodrÃ¡s descargar un PDF con diseÃ±o para regalar"}),e.jsx("li",{children:"â€¢ La persona que reciba el regalo usarÃ¡ los cÃ³digos para reservar"})]})]}),e.jsxs("div",{className:"bg-primary/10 rounded-lg p-3 border border-primary/20",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Seleccionaste:"}),e.jsx("p",{className:"font-semibold text-primary",children:($=o.find(s=>s.id===t))==null?void 0:$.name})]}),e.jsx(C,{type:"submit",className:"w-full",size:"lg",disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"h-4 w-4 animate-spin mr-2"}),"Procesando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"h-4 w-4 mr-2"}),"Comprar Gift Card"]})})]})]})})]})]})}),e.jsx(te,{type:"giftcards"}),e.jsx(ae,{})]})}export{Ne as default};
