import{r as v,V as K,j as e,f as _,Y as z,aD as L,B as l,Z as Q,_ as B,$ as R,I as C,s as o,g as u}from"./index-DgMpF62C.js";import{u as S}from"./useQuery-BTxbnbv1.js";import{u as w}from"./useMutation-CWL1BRlX.js";import{L as d}from"./label-CE2J_Qba.js";import{T as G,a as Y,b,c as t,d as Z,e as i}from"./table-BxbxVbda.js";import{S as D,a as E,b as A,c as q,d as O}from"./select-8dj-i9Ck.js";import{A as $,b as J,c as U,d as W,e as X,f as ee,g as se,h as ae}from"./alert-dialog-B10pn27x.js";import{u as re}from"./index.esm-CwA3zrSh.js";import{o as ie,s as h,n as te,t as ce}from"./zod-yqzwEcrb.js";import{P as oe}from"./plus-C3tBHcL7.js";import{P as ne}from"./pencil-FWxgCYvq.js";import{T as le}from"./trash-2-DAp8J_5G.js";import{k as de,n as me}from"./es-BGq_Vek6.js";import"./index-B-Iwk0i_.js";import"./index-DJwoYwHJ.js";import"./chevron-down-DGyKDyC-.js";import"./chevron-up-BWEP_Trh.js";import"./check-ChRAgIYV.js";const xe=ie({professionalId:h().min(1,"Selecciona un profesional"),serviceId:h().min(1,"Selecciona un servicio"),date:h().min(1,"Selecciona una fecha"),startTime:h().min(1,"Ingresa la hora de inicio"),maxCapacity:te().min(0,"Mínimo 0 cupos").max(100,"Máximo 100 cupos")});function Ae(){const[F,m]=v.useState(!1),[n,x]=v.useState(null),[p,j]=v.useState(null),N=K(),a=re({resolver:ce(xe),defaultValues:{professionalId:"",serviceId:"",date:"",startTime:"",maxCapacity:2}}),{data:c,isLoading:P}=S({queryKey:["capacity-overrides"],queryFn:async()=>{const{data:s,error:r}=await o.from("capacity_overrides").select(`
          *,
          professionals(name),
          services(name, max_capacity)
        `).order("date",{ascending:!0}).order("start_time",{ascending:!0});if(r)throw r;return s}}),{data:f}=S({queryKey:["professionals-for-overrides"],queryFn:async()=>{const{data:s,error:r}=await o.from("professionals").select("id, name").eq("is_active",!0).order("name");if(r)throw r;return s}}),{data:y}=S({queryKey:["services-for-overrides"],queryFn:async()=>{const{data:s,error:r}=await o.from("services").select("id, name, max_capacity").eq("is_active",!0).order("name");if(r)throw r;return s}}),g=w({mutationFn:async s=>{if(n){const{error:r}=await o.from("capacity_overrides").update({professional_id:s.professionalId,service_id:s.serviceId,date:s.date,start_time:s.startTime,max_capacity:s.maxCapacity}).eq("id",n.id);if(r)throw r}else{const{error:r}=await o.from("capacity_overrides").insert({professional_id:s.professionalId,service_id:s.serviceId,date:s.date,start_time:s.startTime,max_capacity:s.maxCapacity});if(r)throw r}},onSuccess:()=>{N.invalidateQueries({queryKey:["capacity-overrides"]}),u.success(n?"Override actualizado":"Override creado"),m(!1),x(null),a.reset()},onError:s=>{u.error(s.message||"Error al guardar override")}}),M=w({mutationFn:async s=>{const{error:r}=await o.from("capacity_overrides").delete().eq("id",s);if(r)throw r},onSuccess:()=>{N.invalidateQueries({queryKey:["capacity-overrides"]}),u.success("Override eliminado"),j(null)},onError:s=>{u.error(s.message||"Error al eliminar override")}}),H=s=>{x(s),a.reset({professionalId:s.professional_id,serviceId:s.service_id,date:s.date,startTime:s.start_time,maxCapacity:s.max_capacity}),m(!0)},V=()=>{m(!1),x(null),a.reset()},k=s=>{g.mutate(s)};return P?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(_,{className:"h-8 w-8 animate-spin"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Gestión de Cupos"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Sobrescribe la capacidad de horarios específicos"})]}),e.jsxs(z,{open:F,onOpenChange:m,children:[e.jsx(L,{asChild:!0,children:e.jsxs(l,{onClick:()=>x(null),children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Agregar Override"]})}),e.jsxs(Q,{className:"max-w-md",children:[e.jsx(B,{children:e.jsx(R,{children:n?"Editar Override":"Nuevo Override"})}),e.jsxs("form",{onSubmit:a.handleSubmit(k),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(d,{children:"Profesional"}),e.jsxs(D,{value:a.watch("professionalId"),onValueChange:s=>a.setValue("professionalId",s),children:[e.jsx(E,{children:e.jsx(A,{placeholder:"Selecciona profesional"})}),e.jsx(q,{children:f==null?void 0:f.map(s=>e.jsx(O,{value:s.id,children:s.name},s.id))})]}),a.formState.errors.professionalId&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:a.formState.errors.professionalId.message})]}),e.jsxs("div",{children:[e.jsx(d,{children:"Servicio"}),e.jsxs(D,{value:a.watch("serviceId"),onValueChange:s=>a.setValue("serviceId",s),children:[e.jsx(E,{children:e.jsx(A,{placeholder:"Selecciona servicio"})}),e.jsx(q,{children:y==null?void 0:y.map(s=>e.jsxs(O,{value:s.id,children:[s.name," (Por defecto: ",s.max_capacity," cupos)"]},s.id))})]}),a.formState.errors.serviceId&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:a.formState.errors.serviceId.message})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"date",children:"Fecha"}),e.jsx(C,{id:"date",type:"date",...a.register("date")}),a.formState.errors.date&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:a.formState.errors.date.message})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"startTime",children:"Hora de Inicio"}),e.jsx(C,{id:"startTime",type:"time",...a.register("startTime")}),a.formState.errors.startTime&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:a.formState.errors.startTime.message})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"maxCapacity",children:"Cupos en este Horario"}),e.jsx(C,{id:"maxCapacity",type:"number",...a.register("maxCapacity",{valueAsNumber:!0})}),a.formState.errors.maxCapacity&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:a.formState.errors.maxCapacity.message})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(l,{type:"button",variant:"outline",onClick:V,children:"Cancelar"}),e.jsxs(l,{type:"submit",disabled:g.isPending,children:[g.isPending&&e.jsx(_,{className:"h-4 w-4 mr-2 animate-spin"}),n?"Actualizar":"Crear"]})]})]})]})]})]}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(G,{children:[e.jsx(Y,{children:e.jsxs(b,{children:[e.jsx(t,{children:"Profesional"}),e.jsx(t,{children:"Servicio"}),e.jsx(t,{children:"Fecha"}),e.jsx(t,{children:"Hora"}),e.jsx(t,{children:"Cupos"}),e.jsx(t,{children:"Por Defecto"}),e.jsx(t,{className:"text-right",children:"Acciones"})]})}),e.jsxs(Z,{children:[(c==null?void 0:c.length)===0&&e.jsx(b,{children:e.jsx(i,{colSpan:7,className:"text-center text-muted-foreground",children:"No hay overrides configurados"})}),c==null?void 0:c.map(s=>{var r,T,I;return e.jsxs(b,{children:[e.jsx(i,{children:(r=s.professionals)==null?void 0:r.name}),e.jsx(i,{children:(T=s.services)==null?void 0:T.name}),e.jsx(i,{children:de(new Date(s.date+"T12:00:00"),"EEEE d 'de' MMMM, yyyy",{locale:me})}),e.jsx(i,{children:s.start_time}),e.jsx(i,{className:"font-bold",children:s.max_capacity}),e.jsxs(i,{className:"text-muted-foreground",children:[(I=s.services)==null?void 0:I.max_capacity," cupos"]}),e.jsx(i,{className:"text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>H(s),children:e.jsx(ne,{className:"h-4 w-4"})}),e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>j(s.id),children:e.jsx(le,{className:"h-4 w-4 text-destructive"})})]})})]},s.id)})]})]})}),e.jsx($,{open:!!p,onOpenChange:()=>j(null),children:e.jsxs(J,{children:[e.jsxs(U,{children:[e.jsx(W,{children:"¿Eliminar override?"}),e.jsx(X,{children:"Esta acción no se puede deshacer. El horario volverá a usar la capacidad por defecto del servicio."})]}),e.jsxs(ee,{children:[e.jsx(se,{children:"Cancelar"}),e.jsx(ae,{onClick:()=>p&&M.mutate(p),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Eliminar"})]})]})})]})}export{Ae as default};
