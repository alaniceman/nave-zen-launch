import{c as D,j as e,Y as O,Z as F,_ as H,$ as I,I as k,B as o,s as d,g as b,W,u as X,V as Y,r as h,a1 as J,M as ee}from"./index-Dk2_iIft.js";import{u as N}from"./useQuery-1cuP94yH.js";import{B as se}from"./badge-DDYLKcTg.js";import{T as q}from"./textarea-eTFBdCan.js";import{u as K}from"./index.esm-BLdTsCOc.js";import{L as _}from"./label-92gvjRpn.js";import{S as ae,a as te,b as re,c as ie,d as ne}from"./select-xacJZTmn.js";import{A as le}from"./arrow-left-C14PiCZ5.js";import{P as oe}from"./pencil-BSMl-lXO.js";import{C as w}from"./crown-BN48Sg7W.js";import{G as P}from"./graduation-cap-SXWxNsa6.js";import{C as ce}from"./circle-check-big-BrXFzJ6t.js";import{C as de}from"./calendar-B8Cn8_Y4.js";import{P as me}from"./package-CJVwaKxw.js";import{G as ue}from"./gift-hmPKSCRi.js";import{k as G,n as z}from"./es-BGq_Vek6.js";import"./index-D7SjGzn6.js";import"./index-C0B6o1EA.js";import"./chevron-down-gt_jZHkk.js";import"./chevron-up-CYtA8oRj.js";import"./check-DciPuYVF.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=D("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=D("StickyNote",[["path",{d:"M16 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8Z",key:"qazsjp"}],["path",{d:"M15 3v4a2 2 0 0 0 2 2h4",key:"40519r"}]]);function xe({customerId:t,onClose:c,onSaved:m}){const{register:x,handleSubmit:p,setValue:g,watch:u,formState:{isSubmitting:f}}=K({defaultValues:{membership_plan_id:"",start_date:new Date().toISOString().split("T")[0],notes:""}}),{data:i=[]}=N({queryKey:["active-membership-plans"],queryFn:async()=>{const{data:r,error:n}=await d.from("membership_plans").select("*").eq("is_active",!0).order("name");if(n)throw n;return r}}),y=async r=>{try{const{error:n}=await d.from("customer_memberships").insert({customer_id:t,membership_plan_id:r.membership_plan_id,start_date:r.start_date,notes:r.notes||null,status:"active"});if(n)throw n;const j=i.find(v=>v.id===r.membership_plan_id);await d.from("customer_events").insert({customer_id:t,event_type:"membership_assigned",title:"MembresÃ­a asignada",description:(j==null?void 0:j.name)||"Plan",metadata:{membership_plan_id:r.membership_plan_id}}),await d.from("customers").update({status:"member"}).eq("id",t),b.success("MembresÃ­a asignada"),m(),c()}catch(n){b.error(n.message||"Error al asignar")}};return e.jsx(O,{open:!0,onOpenChange:c,children:e.jsxs(F,{className:"sm:max-w-md",children:[e.jsx(H,{children:e.jsx(I,{children:"Asignar MembresÃ­a"})}),e.jsxs("form",{onSubmit:p(y),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(_,{children:"Plan"}),e.jsxs(ae,{value:u("membership_plan_id"),onValueChange:r=>g("membership_plan_id",r),children:[e.jsx(te,{children:e.jsx(re,{placeholder:"Seleccionar plan..."})}),e.jsx(ie,{children:i.map(r=>e.jsxs(ne,{value:r.id,children:[r.name," â€” $",r.price_clp.toLocaleString("es-CL")]},r.id))})]})]}),e.jsxs("div",{children:[e.jsx(_,{children:"Fecha inicio"}),e.jsx(k,{type:"date",...x("start_date")})]}),e.jsxs("div",{children:[e.jsx(_,{children:"Notas (opcional)"}),e.jsx(q,{...x("notes"),rows:2})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(o,{type:"button",variant:"outline",onClick:c,children:"Cancelar"}),e.jsx(o,{type:"submit",disabled:f||!u("membership_plan_id"),children:f?"Guardando...":"Asignar"})]})]})]})})}function pe({customerId:t,onClose:c,onSaved:m}){const{register:x,handleSubmit:p,formState:{isSubmitting:g}}=K({defaultValues:{note:""}}),u=async f=>{try{const{error:i}=await d.from("customer_events").insert({customer_id:t,event_type:"note",title:"Nota manual",description:f.note});if(i)throw i;b.success("Nota agregada"),m(),c()}catch(i){b.error(i.message||"Error al guardar")}};return e.jsx(O,{open:!0,onOpenChange:c,children:e.jsxs(F,{className:"sm:max-w-md",children:[e.jsx(H,{children:e.jsx(I,{children:"Agregar Nota"})}),e.jsxs("form",{onSubmit:p(u),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(_,{children:"Nota"}),e.jsx(q,{...x("note",{required:!0}),rows:3,placeholder:"Escribe una nota..."})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(o,{type:"button",variant:"outline",onClick:c,children:"Cancelar"}),e.jsx(o,{type:"submit",disabled:g,children:g?"Guardando...":"Guardar"})]})]})]})})}const ge={new:"Nuevo",trial_booked:"Prueba agendada",trial_attended:"Prueba asistida",purchased:"Comprador",member:"Miembro"},fe={new:"bg-gray-100 text-gray-700",trial_booked:"bg-blue-100 text-blue-700",trial_attended:"bg-yellow-100 text-yellow-700",purchased:"bg-green-100 text-green-700",member:"bg-purple-100 text-purple-700"},je={trial_booked:P,trial_attended:ce,trial_cancelled:P,booking_confirmed:de,package_purchased:me,giftcard_purchased:ue,membership_assigned:w,membership_updated:w,note:M},be={trial_booked:"text-blue-500",trial_attended:"text-green-500",trial_cancelled:"text-red-400",booking_confirmed:"text-indigo-500",package_purchased:"text-emerald-500",giftcard_purchased:"text-pink-500",membership_assigned:"text-purple-500",membership_updated:"text-purple-400",note:"text-yellow-500"};function He(){var V;const{id:t}=W(),c=X(),m=Y(),[x,p]=h.useState(!1),[g,u]=h.useState(!1),[f,i]=h.useState(!1),[y,r]=h.useState(""),[n,j]=h.useState(""),[v,E]=h.useState(""),[A,L]=h.useState(!1),{data:a,isLoading:B}=N({queryKey:["admin-customer",t],queryFn:async()=>{const{data:s,error:l}=await d.from("customers").select("*").eq("id",t).single();if(l)throw l;return s},enabled:!!t}),{data:T=[]}=N({queryKey:["admin-customer-events",t],queryFn:async()=>{const{data:s,error:l}=await d.from("customer_events").select("*").eq("customer_id",t).order("event_date",{ascending:!1});if(l)throw l;return s},enabled:!!t}),{data:S}=N({queryKey:["admin-customer-membership",t],queryFn:async()=>{const{data:s,error:l}=await d.from("customer_memberships").select("*, membership_plans(*)").eq("customer_id",t).eq("status","active").maybeSingle();if(l)throw l;return s},enabled:!!t}),$=s=>s?`https://wa.me/${s.replace(/[^0-9]/g,"")}`:null,C=()=>{m.invalidateQueries({queryKey:["admin-customer",t]}),m.invalidateQueries({queryKey:["admin-customer-events",t]}),m.invalidateQueries({queryKey:["admin-customer-membership",t]})},Q=()=>{r((a==null?void 0:a.name)||""),j((a==null?void 0:a.phone)||""),E((a==null?void 0:a.notes)||""),i(!0)},R=()=>i(!1),U=async()=>{if(!a)return;L(!0);const{error:s}=await d.from("customers").update({name:y.trim(),phone:n.trim()||null,notes:v.trim()||null}).eq("id",a.id);if(L(!1),s){b.error("Error al guardar");return}b.success("Cliente actualizado"),i(!1),C()};return B?e.jsx("div",{className:"p-8 text-gray-500",children:"Cargando..."}):a?e.jsxs("div",{className:"space-y-6",children:[e.jsxs(o,{variant:"ghost",onClick:()=>c("/admin/clientes"),className:"gap-2",children:[e.jsx(le,{className:"h-4 w-4"})," Volver a Clientes"]}),e.jsxs("div",{className:"bg-white rounded-lg border p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4",children:[e.jsx("div",{className:"space-y-1 flex-1",children:f?e.jsxs("div",{className:"space-y-3 max-w-md",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500",children:"Nombre"}),e.jsx(k,{value:y,onChange:s=>r(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500",children:"TelÃ©fono"}),e.jsx(k,{value:n,onChange:s=>j(s.target.value),placeholder:"+56912345678"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500",children:"Notas internas"}),e.jsx(q,{value:v,onChange:s=>E(s.target.value),rows:3,placeholder:"Notas sobre el cliente..."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(o,{size:"sm",onClick:U,disabled:A||!y.trim(),children:[e.jsx(he,{className:"h-4 w-4 mr-1"})," ",A?"Guardando...":"Guardar"]}),e.jsxs(o,{size:"sm",variant:"ghost",onClick:R,children:[e.jsx(J,{className:"h-4 w-4 mr-1"})," Cancelar"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:a.name}),e.jsx(o,{size:"icon",variant:"ghost",className:"h-7 w-7",onClick:Q,children:e.jsx(oe,{className:"h-3.5 w-3.5"})})]}),e.jsx("p",{className:"text-gray-600",children:a.email}),a.phone&&e.jsxs("a",{href:$(a.phone),target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1.5 text-green-600 hover:text-green-700",children:[e.jsx(ee,{className:"h-4 w-4"}),a.phone]}),a.notes&&e.jsxs("p",{className:"text-sm text-gray-500 mt-2 italic",children:["ðŸ“ ",a.notes]})]})}),e.jsxs("div",{className:"flex flex-col items-start sm:items-end gap-2",children:[e.jsx(se,{variant:"outline",className:`text-sm ${fe[a.status]||""}`,children:ge[a.status]||a.status}),S&&e.jsxs("div",{className:"text-sm text-purple-600 font-medium flex items-center gap-1",children:[e.jsx(w,{className:"h-4 w-4"}),(V=S.membership_plans)==null?void 0:V.name," Â· desde ",G(new Date(S.start_date),"dd MMM yyyy",{locale:z})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsxs(o,{size:"sm",onClick:()=>p(!0),children:[e.jsx(w,{className:"h-4 w-4 mr-1"})," Asignar MembresÃ­a"]}),e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>u(!0),children:[e.jsx(M,{className:"h-4 w-4 mr-1"})," Agregar Nota"]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Historial"}),T.length===0?e.jsx("p",{className:"text-gray-400 text-sm",children:"Sin eventos registrados."}):e.jsx("div",{className:"space-y-4",children:T.map(s=>{const l=je[s.event_type]||M,Z=be[s.event_type]||"text-gray-400";return e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:`mt-0.5 ${Z}`,children:e.jsx(l,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-900 text-sm",children:s.title}),s.description&&e.jsx("p",{className:"text-gray-500 text-sm",children:s.description}),e.jsxs("div",{className:"flex items-center gap-3 mt-1",children:[e.jsx("span",{className:"text-xs text-gray-400",children:G(new Date(s.event_date),"dd MMM yyyy Â· HH:mm",{locale:z})}),s.amount!=null&&s.amount>0&&e.jsxs("span",{className:"text-xs font-medium text-green-600",children:["$",s.amount.toLocaleString("es-CL")]})]})]})]},s.id)})})]}),x&&e.jsx(xe,{customerId:a.id,onClose:()=>p(!1),onSaved:C}),g&&e.jsx(pe,{customerId:a.id,onClose:()=>u(!1),onSaved:C})]}):e.jsx("div",{className:"p-8 text-gray-500",children:"Cliente no encontrado"})}export{He as default};
